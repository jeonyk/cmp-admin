
<template>
  <div>
    <el-dialog
      :visible.sync="publicProject.view"
      :title="publicProject.orderNo"
      width="1020px"
      top="5vh"
      @close="loading ? null : close()"
    >
      <div class="aws-project-todo-modal task-project-wrapper">
        <section id="info-section">
          <dashboard-panel
            :title="$t('common.MODAL.projectInfo')"
            :padding-top="0"
          >
            <vertical-table
              :data="publicProject"
              :columns="field === 'todo' ? columns : removeColumn(columns, 'workResult')"
              type="horizontal"
            >
              <template #workResult="{ row }">
                <div
                  class="cell-flex-wrap"
                  v-if="row.workResult"
                >
                  <cmp-status-tag
                    v-if="row.workResult"
                    :type="workResult[row.workResult].type"
                    :contents="row.workResult !== 'PROCEED' ? $t(workResult[row.workResult].contents) : undefined"
                    :tooltip="!!row.failMessage"
                    :tooltip-cont="convertFailMessage(row.failMessage)"
                    tooltip-position="bottom"
                  >
                    <div v-if="row.workResult === 'PROCEED'">
                      <i
                        class="el-icon-loading"
                        style="margin-right: 5px;"
                      />
                      <span>{{ $t('task.TODO.working') }}</span>
                    </div>
                  </cmp-status-tag>
                  <button
                    v-if="publicProject.workResult === 'ERROR' && field === 'todo'"
                    class="button"
                    style="margin-left: 10px;"
                    @click.stop="setResultSuccess"
                  >
                    {{ $t('common.BTN.TASK.success') }}
                  </button>
                </div>
              </template>
              <!-- ÏûëÏóÖ ÏÉÅÌÉú -->
            </vertical-table>
          </dashboard-panel>
        </section>
        <!-- ÌîÑÎ°úÏ†ùÌä∏ Ï†ïÎ≥¥ -->

        <section id="account-section">
          <dashboard-panel
            :title="$t('common.BTN.ADMIN.regAcc')"
            :padding-top="0"
          >
            <div
              class="hidden-access-key"
              v-if="hiddenAccessKey"
            >
              <template v-if="field !== 'done' && data && data.orderType === 'NEW'">
                <p>{{ $v('ÌòÑÏû¨ Î°úÍ∑∏Ïù∏Îêú Í≥ÑÏ†ïÏùò ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†• ÌõÑ ÌôïÏù∏ Í∞ÄÎä•Ìï©ÎãàÎã§.') }}</p>
                <div
                  class="flex-wrap"
                  style="gap: 10px; justify-content: flex-start; align-items: flex-start;"
                >
                  <div>
                    <el-input
                      class="login-input"
                      style="width: 300px"
                      v-model="accountPw"
                      show-password
                      @input="() => failMessage !== undefined ? failMessage = undefined : null"
                      @keyup.native.enter="confirmPw(accountPw)"
                    />
                    <small class="wrong-alert">{{ failMessage }}</small>
                  </div>
                  <button
                    class="button"
                    type="is-primary"
                    :disabled="!accountPw"
                    @click="confirmPw(accountPw)"
                  >
                    {{ $v('ÌôïÏù∏') }}
                  </button>
                </div>
              </template>
              <!-- /. ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏ -->

              <template v-else>
                <span
                  class="disable-text"
                  v-html="$v('Í≥ÑÏ†ï Îì±Î°ù ÏôÑÎ£å<br>Íµ¨ÏÑ± Í¥ÄÎ¶¨ > ÌîÑÎ°úÏ†ùÌä∏ Í¥ÄÎ¶¨ÏóêÏÑú ÌôïÏù∏ Î∞îÎûçÎãàÎã§.')"
                />
              </template>
            </div>
            <!-- /. [Í≥ÑÏ†ï Îì±Î°ù] Ï†Ñ ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏ -->

            <vertical-table
              v-else
              :data="accessKeyInfo"
              :columns="accessKeyInfoColumns"
            >
              <template
                v-for="col in accessKeyInfoColumns"
                v-slot:[col.binding]
              >
                <div
                  class="flex-wrap"
                  :key="col.binding"
                >
                  <el-input
                    v-model="accessKeyInfo[col.binding]"
                    :disabled="!editAccessKey"
                  >
                    <a
                      v-if="editAccessKey"
                      slot="suffix"
                      class="save-key-btn"
                      @click="validateAccessKey"
                    >
                      {{ $v('Ï†ÄÏû•') }}
                    </a>
                  </el-input>

                  <button
                    v-if="showExecute"
                    class="button -icon"
                    type="is-icon"
                    @click="editAccessKey ? cancelAccessKey() : changeAccessKey()"
                  >
                    <i :class="editAccessKey ? '-close-icon' : '-edit-icon'" />
                  </button>
                </div>
              </template>
            </vertical-table>
          </dashboard-panel>
          <!-- Í≥ÑÏ†ï Îì±Î°ù -->
        </section>

        <div
          class="button-area -center"
          v-if="field === 'todo'"
        >
          <button
            v-if="showExecute"
            class="button"
            size="is-large"
            type="is-primary"
            :disabled="editAccessKey"
            @click="confirmExecuteWork"
          >
            <!-- ÏûëÏóÖ Ïã§Ìñâ -->
            {{ $t('common.BTN.TASK.exec') }}
          </button>
          <button
            v-if="showComplete"
            class="button"
            size="is-large"
            type="is-primary"
            :disabled="editAccessKey"
            @click="setRoleDone"
          >
            <!-- ÏûëÏóÖ ÏôÑÎ£å -->
            {{ $t('common.BTN.TASK.doneExec') }}
          </button>
        </div>
        <!-- [Ìï† Ïùº] ÏûëÏóÖ Ïã§Ìñâ / ÏûëÏóÖ ÏôÑÎ£å -->

        <section id="memo-section">
          <dashboard-panel
            :title="$t('task.TODO.DETAIL.note')"
            :padding-top="0"
          >
            <task-memo
              :data="taskMemoList"
              @refresh-memo="activePublicProject(data, true)"
            />
          </dashboard-panel>
        </section>
        <!-- /. Î©îÎ™® ÏòÅÏó≠ -->
      </div>

      <div class="modal-button-area">
        <button
          class="button -modal-button"
          type="is-primary"
          @click="close()"
        >
          <!-- ÌôïÏù∏ -->
          {{ $t('common.BTN.confirm') }}
        </button>
      </div>
    </el-dialog>
    <!-- /. [AWS ÌîÑÎ°úÏ†ùÌä∏ Î™®Îã¨ ÎÅù] -->

    <!-- Î™®Îã¨ -->
    <el-dialog
      class="none-header approve-modal"
      :visible.sync="failModal"
      width="330px"
      top="35vh"
    >
      <p class="action-message">
        {{ $t('task.PRIOR.DETAIL.actionMessage') }}
      </p>

      <div>
        <el-input
          type="textarea"
          :autosize="{ minRows: 5, maxRows: 6 }"
          :placeholder="$t('task.TODO.DETAIL.enterFail')"
          resize="none"
          v-model="failReason"
          style="margin-top: 10px;"
        />
      </div>

      <div class="modal-button-area">
        <button
          class="button -modal-button"
          @click="failModal = false"
        >
          <!-- Ï∑®ÏÜå -->
          {{ $t('common.BTN.cancel') }}
        </button>
        <button
          class="button -modal-button"
          type="is-primary"
          @click="e=>{
            failModal = false
            forceComplete()
          }"
        >
          {{ $t('common.BTN.confirm') }}
        </button>
      </div>
    </el-dialog>
  </div>
</template>

<script>

import TaskMemo from '../Nutanix/TaskMemo/TaskMemo'
import AWSProjectMixins from './AWSProjectMixins.script'
import API, { DashboardPanel } from '@sd-fe/cmp-core'
import { mapState } from 'vuex'

export default {
  components: {
    'task-memo': TaskMemo,
    'dashboard-panel': DashboardPanel
  },
  mixins: [AWSProjectMixins],
  props: {
    active: {
      type: Boolean,
      default: false
    },
    data: {
      type: Object,
      default: () => {}
    },
    field: {
      type: String, // 'todo', 'done'
      default: ''
    }
  },
  mounted () {
  },
  watch: {
    active (view) {
      this.activePublicProject(this.data, view)
    }
  },
  computed: {
    ...mapState({
      userInfo: state => state.auth.user,
      user: state => state.auth.user
    }),
    /**
     * [ÏûëÏóÖÏã§Ìñâ] Î≤ÑÌäº disabled Ï°∞Í±¥
     */
    showExecute () {
      const { workResult } = this.publicProject
      return workResult === undefined || /ERROR/g.test(workResult)
    },
    /**
     * [ÏûëÏóÖÏôÑÎ£å] Î≤ÑÌäº disabled Ï°∞Í±¥
     */
    showComplete () {
      const { workResult } = this.publicProject
      return /ERROR|DONE/g.test(workResult)
    }
  },
  destroyed () {
    clearTimeout(this.time)
  },
  methods: {
    /**
     * interval Ï£ºÍ∏∞Ï†ÅÏúºÎ°ú ÎèåÎ¶¨Í∏∞
     */
    timeout () {
      if (this.time) {
        clearTimeout(this.time)
        this.time = null
      }
      this.time = setTimeout(() => this.activePublicProject(this.data, true), 5000)
    },

    async activePublicProject ({ id, project, orderType, ...data }, status) {
      if (!status) return this.close()

      try {
        this.loading = true
        // todo(getTaskTodo) / done(getTaskDone)
        this.publicProjectDetail = (this.field === 'todo') ? await API.work.getTaskTodo(id) : await API.work.getTaskDone(id)

        // üî∏ (220407) AWS ÌîÑÎ°úÏ†ùÌä∏Îäî ÌïúÍ∞úÎ∞ñÏóê Ïã†Ï≤≠Î™ªÌïòÎãàÍπå ... ÏùºÎã® Ïù¥Î†áÍ≤å ... ÏûÑÏãú
        const roles = this.publicProjectDetail.roles.filter(role => role.roleMemo === 'AWSÌîÑÎ°úÏ†ùÌä∏')[0]
        const detail = roles.taskList[0].resourceList[0]

        // ÏÑ†ÌÉù VPC
        const envType = { STG: this.$v('Ïä§ÌÖåÏù¥Ïßï'), DEV: this.$v('Í∞úÎ∞ú'), PRD: this.$v('Ïö¥ÏòÅ') }
        const environment = detail.orderData?.projectDto?.projectMapDto?.map(({ environment }) => envType[environment]) || []
        const date = (date, format = 'YYYY.MM.DD HH:mm:ss') => this.$options.filters.date(date, format)

        const copyData = Object.assign({
          orderNo: this.publicProjectDetail.orderNo, // ÌîÑÎ°úÏ†ùÌä∏ Î≤àÌò∏
          companyName: `${this.publicProjectDetail.companyName} > ${this.publicProjectDetail.groupName}`, // Í¥ÄÍ≥ÑÏÇ¨
          displayName: detail.orderData.projectDto.region, // ÏÇ¨Ïö© Region
          environment: environment.join('/'), // ÏÑ†ÌÉù VPC
          projectName: this.publicProjectDetail.projectName,
          moduleType: this.publicProjectDetail.moduleType, // Public Cloud Ïú†Ìòï
          orderType,
          workResult: detail.proceedStatus, // ÏûëÏóÖ ÏÉÅÌÉú
          failMessage: detail.taskSendRes ? detail.taskSendRes.failMessage : '-', // ÏÇ¥Ìå® ÏÇ¨Ïú†
          applyDate: date(this.publicProjectDetail.approvalCreateTime), // ÌòëÏùò ÏãúÏûëÏùº
          doneDate: date(this.publicProjectDetail.doneDate) || '-', // ÏôÑÎ£åÏùº
          accessKey: detail.orderData.projectDto.accessKey || undefined,
          secretKey: detail.orderData.projectDto.secretKey || undefined,
          regionName: detail.orderData.projectDto.regionName
        })

        // Î©îÎ™® Î™©Î°ù ÏÑ§Ï†ï
        this.taskMemoList = {
          orderNo: this.publicProjectDetail.orderNo,
          data: this.publicProjectDetail.orderMemoList?.filter(memo => !memo.isDeleted)
        }

        // console.log(this.publicProjectDetail, 'this.publicProjectDetail')
        // ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï†ÄÏû•
        this.publicProject = { ...copyData, view: status }

        // accessKey Î≥µÏÇ¨
        this.accessKeyInfo = {
          ...this.publicProject,
          accessKey: this.publicProject.accessKey || undefined,
          secretKey: this.publicProject.secretKey || undefined
        }

        // Ïù∏ÌÑ∞Î≤åÏùÑ ÎèåÎ¶¥ÏßÄ ÌôïÏù∏Ìï©ÎãàÎã§ workResult Î•º ÌôïÏù∏ÌïòÏó¨ ÏÑ§Ï†ïÌï©ÎãàÎã§
        if (/WAIT|PROCEED/g.test(this.publicProject.workResult)) this.timeout()
      } catch (error) {
        console.error('@@ activePublicProject : ', error)
        return this.close()
      } finally {
        this.loading = false
      }
    },

    /**
     * [Ï†ÄÏû•] ÌÅ¥Î¶≠Ïãú AccessKey Î•º Í≤ÄÏÇ¨Ìï©ÎãàÎã§.
     */
    async validateAccessKey () {
      this.loading = true
      const isValid = await this.checkKey(this.accessKeyInfo)
      this.loading = false
      if (!isValid) return this.$alert(this.$v('Access Key Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.'), { callback: () => false })

      this.editAccessKey = false
      return this.activePublicProject(this.data, true)
    },

    /**
     * AWS ÌîÑÎ°úÏ†ùÌä∏ AccessKey Ï†ïÎ≥¥ Ï†ÄÏû•
     */
    async saveKey ({ accessKey, secretKey }) {
      try {
        const roles = this.publicProjectDetail.roles.filter(role => role.roleMemo === 'AWSÌîÑÎ°úÏ†ùÌä∏')[0]
        const detail = roles.taskList[0].resourceList[0]

        const { orderDataIdx, orderNo, roleIdx, orderType, workType } = detail
        detail.orderData.projectDto = { ...detail.orderData.projectDto, accessKey, secretKey }

        const payload = {
          userId: this.user?.userId,
          userName: this.user?.userName,
          userPosition: this.user?.userPosition,
          groupIdx: this.user?.userGroup,
          groupName: this.user?.userGroupName,
          taskDataList: [{
            orderDataIdx,
            orderNo,
            roleIdx,
            orderType,
            workType,
            orderData: detail.orderData
          }]
        }

        // console.log(JSON.stringify(payload), payload)
        await API.work.saveKey(payload)

        return true
      } catch (error) {
        console.error('@@ saveKey : ', error)
        this.$alert(this.$v('Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. <br> Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.'), {
          dangerouslyUseHTMLString: true,
          callback: () => false
        })
      } finally {
        this.loading = false
      }
    },

    /**
     * AccessKey [Î≥ÄÍ≤Ω] Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌñàÏùÑÎïå Î∞úÏÉùÌï©ÎãàÎã§
     */
    changeAccessKey () {
      this.editAccessKey = !this.editAccessKey
    },

    /**
     * AccessKey Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏùÑ [Ï∑®ÏÜå] Ìï†Îïå ÏÇ¨Ïö©ÎêòÎäî Î©îÏÑúÎìúÏûÖÎãàÎã§
     */
    cancelAccessKey () {
      this.accessKeyInfo = {
        accessKey: this.publicProject.accessKey,
        secretKey: this.publicProject.secretKey
      }
      this.editAccessKey = false
    },

    confirmExecuteWork () {
      this.$confirm(this.$v('ÏÑ†ÌÉùÌïú ÏûêÏõêÏóê ÎåÄÌïú ÏûëÏóÖÏùÑ Ïã§ÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå?'), 'ÏïåÎ¶º', {
        confirmButtonText: this.$t('common.BTN.confirm'),
        cancelButtonText: this.$t('common.BTN.cancel'),
        dangerouslyUseHTMLString: true
      }).then(async () => this.executeWork())
        .catch(() => false)
    },

    /**
     * [ÏûëÏóÖ Ïã§Ìñâ]
     */
    async executeWork () {
      const roles = this.publicProjectDetail.roles.filter(role => role.roleMemo === 'AWSÌîÑÎ°úÏ†ùÌä∏')[0]
      const detail = roles.taskList[0].resourceList[0]

      const { orderDataIdx, orderNo, orderType, workType } = detail
      const reqData = [{ orderDataIdx, orderNo, orderType, workType }]
      const payload = {
        orderNo,
        userId: this.userInfo?.userId,
        userName: this.userInfo?.userName,
        userPosition: this.userInfo?.userPosition,
        groupIdx: this.userInfo?.userGroup,
        groupName: this.userInfo?.userGroupName,
        reqData
      }

      // console.log('@@ payload : ', payload, JSON.stringify(payload))
      const response = await API.work.runTasks(payload)

      if (response.status === 500) {
        const status = response.data.message.split(': ')[1].replace(' )', '')
        const message = { WAIT: this.$t('task.STATE.wait') }[status]
        // `ÏûëÏóÖ ${message}Ï§ëÏù∏ ÏûêÏõêÏù¥ ÏûàÏäµÎãàÎã§.`
        return this.$alert(this.$t('common.ALERT.CONF.014', { message }))
      } else {
        // ÏûëÏóÖ ÎÅùÎÇ¨ÏùÑ Îïå Ï≤òÎ¶¨
        this.activePublicProject(this.data, true)
      }
    },

    /**
     * [ÏûëÏóÖÏôÑÎ£å] Î≤ÑÌäº ÌÅ¥Î¶≠Ïãú Ïã§Ìñâ
     */
    setRoleDone () {
      const isProceeding = this.publicProject.workResult === 'PROCEED'
      const isWaiting = this.publicProject.workResult === 'WAIT'
      const isError = this.publicProject.workResult === 'ERROR'

      // ÏßÑÌñâÏ§ëÏù∏ ÏûëÏóÖÏù¥ ÏûàÏäµÎãàÎã§.
      if (isProceeding) return this.$alert(this.$t('common.ALERT.CONF.006'))

      // ÏûîÏó¨ ÏûëÏóÖÏù¥ ÏûàÏäµÎãàÎã§. (Ïã§ÌñâÎåÄÍ∏∞Ï§ë Ïù¥Í±∞ÎÇò or ÎÑòÏñ¥Í∞ÄÎèÑ ÎêòÎäîÏßÄ ÌÖåÏä§Ìä∏ ÌÜµÍ≥º Î™ªÌñàÍ±∞ÎÇò)
      if (isWaiting) return this.$alert(this.$t('common.ALERT.CONF.004'))

      // if (isError && !this.isFailMsg) {
      if (isError) {
        // 'Ïã§Ìå®Ìïú ÏûëÏóÖÏù¥ ÏûàÏäµÎãàÎã§. <br> Í≥ÑÏÜç ÏßÑÌñâÌïòÏãúÍ≤†ÏäµÎãàÍπå?
        this.$confirm(this.$t('common.ALERT.CONF.001'), 'ÏïåÎ¶º', {
          dangerouslyUseHTMLString: true,
          confirmButtonText: this.$t('common.TERMS.yes'),
          cancelButtonText: this.$t('common.TERMS.no')
        }).then(() => { this.failModal = true })
          .catch(() => false)
        return false
      }

      // Ìï¥Îãπ ÏûëÏóÖÏùÑ ÏôÑÎ£å Ï≤òÎ¶¨ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?
      return this.$confirm(this.$t('common.CONFIRM.CONF.007'), 'ÏïåÎ¶º', {
        confirmButtonText: this.$t('common.BTN.confirm'),
        cancelButtonText: this.$t('common.BTN.cancel')
      }).then(async () => this.confirmTask())
        .catch(() => false)
    },

    async confirmTask () {
      try {
        this.loading = true
        const roles = this.publicProjectDetail.roles.filter(role => role.roleMemo === 'AWSÌîÑÎ°úÏ†ùÌä∏')[0]
        const detail = roles.taskList[0].resourceList[0]

        const { orderType, roleIdx } = detail

        const { userId, userName, userPosition, userGroup, userGroupName } = this.userInfo
        const { orderNo } = this.publicProject
        const payload = {
          orderNo,
          roleIdx,
          roleName: roles.roleName,
          lastRole: roleIdx,
          orderType,
          userId,
          userName,
          userPosition,
          groupIdx: userGroup,
          groupName: userGroupName
        }

        const response = await API.work.updateTodoStatus(payload)

        if (response) {
          // ÏûëÏóÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§. <br> Ìïú ÏùºÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå? <br> Ï∑®ÏÜå Ïãú Ìï† Ïùº Î™©Î°ùÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.
          this.$confirm(this.$t('task.TODO.DETAIL.finishedComplete'), '', {
            dangerouslyUseHTMLString: true,
            confirmButtonText: this.$t('common.BTN.confirm'),
            cancelButtonText: this.$t('common.BTN.cancel')
            // Ìïú ÏùºÎ°ú ÎùºÏö∞Ìä∏
          }).then(() => this.$router.push({ name: 'task-done' }))
            // Ìï† Ïùº Î¶¨Ïä§Ìä∏Î°ú ÎùºÏö∞Ìä∏
            .catch(() => this.close(true))
        }

        this.loading = false
        return true
      } catch (error) {
        console.error(error)
        this.loading = false
        // ÏûëÏóÖÏùÑ ÏôÑÎ£åÌïòÎäî ÎèÑÏ§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌïòÏòÄÏäµÎãàÎã§. <br> Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌï¥Ï£ºÏÑ∏Ïöî.
        this.$alert(this.$t('task.TODO.DETAIL.errorComplete'))
        return false
      }
    },

    /**
     * ÏÑ±Í≥µ Ï≤òÎ¶¨
     */
    async setResultSuccess (data) {
      const roles = this.publicProjectDetail.roles.filter(role => role.roleMemo === 'AWSÌîÑÎ°úÏ†ùÌä∏')[0]
      const detail = roles.taskList[0].resourceList[0]

      const { orderDataIdx } = detail

      const payload = {
        orderDataIdx,
        userId: this.userInfo?.userId,
        userName: this.userInfo?.userName,
        userPosition: this.userInfo?.userPosition,
        groupIdx: this.userInfo?.userGroup,
        groupName: this.userInfo?.userGroupName
      }
      const response = await API.work.createRunTaskResultSuccess(payload)

      if (response) this.activePublicProject(this.data, true)
    },

    /**
     * Ïã§Ìå® ÌõÑ ÏûëÏóÖÏôÑÎ£å Ï≤òÎ¶¨ Ïãú Ïã§Ìñâ. Ïã§Ìå® ÏÇ¨Ïú† ÏûÖÎ†• Ï∞Ω Îú∏.
     */
    async forceComplete () {
      if (!this.failReason) {
        // Ïã§Ìå® ÏÇ¨Ïú†Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.
        this.$alert(this.$t('task.TODO.DETAIL.enterFail'))
        this.failModal = true
        return
      }

      const taskDone = await this.confirmTask()
      if (taskDone) return this.sendMemo(this.failReason, true)
    },

    /**
     * memo Î•º Ï†ÄÏû•Ìï©ÎãàÎã§.
     */
    async sendMemo (memo, isUser) {
      const user = this.userInfo
      const memoData = {
        companyIdx: user.userCompany,
        companyName: user.userCompanyName,
        groupIdx: user.userGroup,
        groupName: user.userGroupName,
        memo,
        orderNo: this.publicProject.orderNo,
        userId: user.userId,
        userName: user.userName,
        userPosition: user.userPosition
      }

      // ÏÇ¨Ïö©Ïûê ÌôîÎ©¥ ÎÖ∏Ï∂úÏó¨Î∂Ä Í≤∞Ï†ï
      if (isUser) memoData.isUser = true

      try {
        const insert = await API.work.insertMemo(memoData)

        if (insert) {
          this.activePublicProject(this.data, true)
          this.isFailMsg = false
          this.failReason = undefined
        }
      } catch (error) {
        console.error('@@@ insertMemo Error', error)
      }
    },

    close (call = false) {
      this.publicProject.view = false
      this.accountPw = undefined
      this.hiddenAccessKey = true
      this.editAccessKey = false
      clearTimeout(this.time)

      this.$emit('close')
      if (call) this.$emit('call')
    },

    /**
     * vertical tableÏóêÏÑú columnÏùÑ Ï†úÍ±∞Ìï©ÎãàÎã§.
     * @param {Array} columns columns
     * @param {String, Array} binding Ï†úÍ±∞ Ìï† columnÏùò binding ÌÇ§
     */
    removeColumn (columns, binding) {
      let filteredColumns
      if (Array.isArray(binding)) { // Ï†úÍ±∞ Ìï† columnÏù¥ Î∞∞Ïó¥Î°ú Îì§Ïñ¥Ïò¨ Îïå
        filteredColumns = columns.filter(col => !binding.includes(col.binding))
      } else filteredColumns = columns.filter(col => col.binding !== binding)
      filteredColumns[0].colspan = true
      return filteredColumns
    }
  },
  data: root => ({
    loading: false,
    time: null,
    publicProjectDetail: null,
    publicProject: {}, // ÌîÑÎ°úÏ†ùÌä∏ Í≤∞Ïû¨ Î™®Îã¨ Îç∞Ïù¥ÌÑ∞
    accessKeyInfo: {
      accessKey: undefined,
      secretKey: undefined
    },
    editAccessKey: false,
    isFailMsg: false,
    taskMemoList: undefined,
    failModal: false,
    failReason: '',
    hiddenAccessKey: true, // access ÌÇ§ read Í∞ÄÎä• Ïó¨Î∂Ä
    accountPw: '', // ÌòÑÏû¨ Î°úÍ∑∏Ïù∏Îêú Í≥ÑÏ†ïÏùò ÎπÑÎ∞ÄÎ≤àÌò∏ Ïù∏Ìíã Ï∞ΩÏóê Ï†ÅÌûå Í∞í
    failMessage: undefined, // Í≥ÑÏ†ï Ìå®Ïä§ÏõåÎìú Ïã§Ìå® Î©îÏÑ∏ÏßÄ
    columns: [
      { binding: 'projectName', header: root.$v('ÌîÑÎ°úÏ†ùÌä∏ Î™Ö') },
      { binding: 'workResult', header: root.$v('ÏûëÏóÖ ÏÉÅÌÉú'), customHtml: true },
      { binding: 'companyName', header: root.$v('Í¥ÄÍ≥ÑÏÇ¨') },
      { binding: 'moduleType', header: root.$v('Public Cloud Ïú†Ìòï') },
      { binding: 'displayName', header: root.$v('ÏÇ¨Ïö© Region') },
      { binding: 'environment', header: root.$v('ÏÑ†ÌÉù VPC') },
      { binding: 'applyDate', header: root.$v('ÌòëÏùò ÏãúÏûëÏùº') },
      { binding: 'doneDate', header: root.$v('ÏôÑÎ£åÏùº') }
    ],
    accessKeyInfoColumns: [
      { binding: 'accessKey', header: 'Access Key' },
      { binding: 'secretKey', header: 'Secret Access Key' }
    ],
    workResult: {
      WAIT: { type: 'is-wait', contents: 'task.TODO.waitWork' },
      PROCEED: { type: 'is-loading', contents: 'task.TODO.working' },
      DONE: { type: 'is-success', contents: 'common.success' },
      ERROR: { type: 'is-fail', contents: 'common.fail' }
    },
    convertFailMessage (raw) {
      // [ÏãúÎÆ¨Î†àÏù¥ÏÖò] Ïã§Ìå®ÏÇ¨Ïú† JSON Îç∞Ïù¥ÌÑ∞ Í∞ÄÍ≥µ (üü° JSON Îç∞Ïù¥ÌÑ∞Í∞Ä ÌíÄÎ°ú ÎÇòÏò§ÏßÄ ÏïäÏùÄ ÏÉÅÌÉú)
      // const message = raw.split(' : ')[1]
      // const result = JSON.parse(message).map(({ code, message }) => {
      //   return `${code} : ${message}`
      // })
      // return result.join('<br>')
      return raw
    }
  })
}
</script>

<style lang="scss" scoped>
.task-project-wrapper {
  height: 70vh;
  overflow-y: auto;
}

#account-section {
  margin-top: $gap-m;
  .hidden-access-key {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 160px;
    border-radius: $radius;
    background-color: $ticket-back-color;
    > p { margin-bottom: $gap; font-size: 14px; text-align: center; }
    .wrong-alert { display: block; margin-top: 10px; color: $main-red; font-size: 12px;}
  }

  .save-key-btn {
    margin-right: 12px;
    font-size: 13px;
    line-height: 32px;
    color: $purple;
  }
}

#memo-section {
  margin-top: $gap-m;
  padding: $gap $gap-m;
  border-radius: $radius;
  border: 1px solid $border2A;
}

.disable-text {
  text-align: center;
  line-height: 1.3;
  color: $text-lighter-gray;
}

.-icon {
  margin-left: 5px;

  .-close-icon {
    display: block;
    width: 20px;
    height: 20px;
    background-color: $white;
    border-radius: 50%;
    position: relative;
    cursor: pointer;

    &::before, &::after {
      content: '';
      position: absolute;
      background: $text-black;
      width: 10px;
      height: 1px;
      top: 10px; left: 5px;
    }
    &::before {
      transform: rotate(-45deg);
    }
    &::after {
      transform: rotate(45deg);
    }
  }
}
</style>

<style lang="scss">
.aws-project-todo-modal {
  .login-input {
    > .el-input__inner {
      &[type=text] {
        & + .el-input__suffix {
          .el-input__suffix-inner {
            .el-icon-view {
              position: relative !important;
              &::before {
                position: absolute;
                display: inline-block !important;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
              }
              &::after {
                content: '';
                position: absolute;
                top: 26%;
                left: 50%;
                transform: translate(-50%, -50%);
                height: 16px;
                width: 1px;
                transform: rotate(-45deg);
                background: $main-red;
              }
            }
          }
        }
      }
    }
  }
}

</style>
