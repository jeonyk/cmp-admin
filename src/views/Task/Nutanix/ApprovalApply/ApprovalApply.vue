<!--
  * ÌååÏùºÎ™Ö : ApprovalApply.vue
  * ÌååÏùº Í∏∞Îä• : Í≤∞Ïû¨ Ïã†Ï≤≠ ÌéòÏù¥ÏßÄ
  * ÏûëÏÑ±Ïûê : ·Ñã·Öµ·ÑÄ·Öß·Üº·Ñí·Ö™·Ü´ Ïô∏ 3Î™Ö
  * ÏµúÏ¢Ö ÏûëÏÑ±Ïùº : 2021-02-18
  * License By Shinsegae I&C
  * 2021-02-18 fix: Ï†ëÍ∑º Î∂àÍ∞ÄÎä• ÌéòÏù¥ÏßÄ Ï†ëÍ∑º ÌõÑ Îí§Î°úÍ∞ÄÍ∏∞Ïãú Ïù¥Îèô Î∂àÍ∞ÄÎä• Î≤ÑÍ∑∏ ÏàòÏ†ï
 -->

<template>
  <section
    :class="['approval-apply', { '-watermark': isProd }]"
    v-loading="loading"
  >
    <button
      class="button -pdf-download"
      type="is-icon"
      style="display: none"
    >
      <pdf-download
        ref="pdfDownload"
        capture-el=".approval-apply-document"
        :file-name="reportName"
        file-background-color="#fff"
      />
    </button>
    <article>
      <h3 class="product-title">
        <!-- Í≤∞Ïû¨ Ï†ïÎ≥¥ -->
        {{ $v("Í≤∞Ïû¨ Ï†ïÎ≥¥") }}
      </h3>

      <div class="approved-information-wrap" />

      <register-contents
        required
        :title="$v('Ï†úÎ™©')"
        style="border-top: 1px solid $line-dark-gray"
      >
        <el-input
          :placeholder="$v('Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.')"
          v-model="task.name"
          :maxlength="100"
        />
      </register-contents>
      <!-- Ï†úÎ™© -->

      <register-contents
        required
        :title="$v('Í≤∞Ïû¨ÏÑ† ÏÑ§Ï†ï')"
        style="border-top: 1px solid $line-dark-gray"
      >
        <button
          class="button"
          type="is-primary"
          @click="blsmModal = true"
        >
          {{ $v("ÏÑ§Ï†ï") }}
        </button>
        <el-tag
          v-if="approvers && approvers.length"
          style="margin-left: 10px"
        >
          {{ approverTags(approvers) }}
        </el-tag>
      </register-contents>
      <!-- Í≤∞Ïû¨ÏÑ† ÏÑ§Ï†ï -->

      <register-contents
        :title="$v('ÏôÑÎ£åÌù¨ÎßùÏùº')"
        required
      >
        {{ expectDate }}
      </register-contents>
      <!-- ÏôÑÎ£å Ìù¨ÎßùÏùº -->

      <register-contents
        :title="$v('Í≤∞Ïû¨ ÎÇ¥Ïö©')"
        required
      >
        <el-input
          resize="none"
          type="textarea"
          v-model="task.reason"
          :placeholder="$v('Î©îÎ™®')"
          ref="textarea"
          @keyup.native.stop="ctrlTextAreaSize"
          @keydown.native.stop="ctrlTextAreaSize"
        />
      </register-contents>
      <!-- Í≤∞Ïû¨ ÎÇ¥Ïö© -->

      <register-contents :title="$v('ÌååÏùº ÏóÖÎ°úÎìú')">
        <el-upload
          :class="['cmp-upload', { 'is-disabled': false }] "
          ref="upload"
          action=""
          :on-change="fileOnChange"
          :before-remove="fileBeforeDelete"
          :auto-upload="false"
          :multiple="true"
          :limit="5"
          :file-list="fileList"
          :on-exceed="handleExceed"
          :on-preview="previewHandler"
        >
          <!-- :before-upload="beforeAvatarUpload" -->
          <button
            slot="trigger"
            class="button"
            type="is-primary"
          >
            {{ $v("ÌååÏùº ÏóÖÎ°úÎìú") }}
          </button>
        </el-upload>
        <!-- /. Ï≤®Î∂Ä ÌååÏùº -->
      </register-contents>

      <article class="button-area -center">
        <button
          class="button"
          size="is-large"
          type="is-primary"
          @click="setTask"
        >
          {{ $v("Í≤∞Ïû¨") }}
        </button>
      </article>
    </article>
    <!-- /. Í≤∞Ïû¨ Ï†ïÎ≥¥ -->

    <div v-if="useDoc">
      <h1>
        {{ reportName }}
      </h1>
      <article
        class="document-preview approval-apply-document"
        style="padding: 50px; background: #fff; color: #000; border-radius: 4px"
      />
    </div>
    <!-- /. Î≥¥Í≥†ÏÑú ÎØ∏Î¶¨Î≥¥Í∞Ä -->

    <div v-else>
      <aws-task-tabs
        v-if="cloud === 'AWS'"
        :is-review-mode="true"
        :data="orderList"
      />
      <task-resource
        v-else
        :data="orderList"
      />
    </div>

    <!-- Ï°∞ÏßÅÎèÑ Î™®Îã¨ -->
    <approval-modal
      v-if="blsmModal"
      :active.sync="blsmModal"
      :data="approvers"
      @confirm="saveApprovers"
      @close="blsmModal = false"
    />
  </section>
</template>

<script>
import ApprovalMemberModal from '@/components/Modal/ApprovalMemberModal/ApprovalMemberModal'
import TaskResource from '../TaskResource/TaskResource'
import AwsTaskTabs from '@/components/TaskTabs/AwsTaskTabs.vue'
import TaskDetailCommon from '../TaskDetailCommon'

import API, { RegisterContents } from '@sd-fe/cmp-core'
import Dayjs from 'dayjs'
import { mapState } from 'vuex'

export default {
  name: 'ApprovalApply',
  mixins: [TaskDetailCommon],
  components: {
    RegisterContents,
    'task-resource': TaskResource,
    AwsTaskTabs,
    'approval-modal': ApprovalMemberModal
  },
  provide () {
    return {
      $field_V3: () => '',
      $orderType: () => this.orderList?.[0]?.workItemRsps?.[0]?.resourceType
    }
  },
  computed: {
    ...mapState({
      user: state => state.auth.user,
      userInfo: state => state.common.userInfo,
      selectedProject: state => state.project.selectedProject,
      isProd: state => state.common.isProd,
      packageType: state => state.common.packageType,
      cloud: state => state.cloud.cloud.toUpperCase()
    })
  },

  /*
    (üü© ÌïÑÎèÖ) ÌïÑÏàò ÌååÎùºÎØ∏ÌÑ∞ & ÏøºÎ¶¨

    @@ params
      step: "conference|todo"
      orderNo // Ï£ºÎ¨∏Î≤àÌò∏

    @@ query
      orderType: "NEW|CHANGE|DELETE" // Ï£ºÎ¨∏ ÌÉÄÏûÖ
      roleIdx
      useDoc: "true|false" // Î≥¥Í≥†ÏÑú ÏÑ§Ï†ï Ïó¨Î∂Ä
      workState: "REVIEW|TODO" // ÌòÑÏû¨ Ï£ºÎ¨∏Ïùò ÏÉÅÌÉú
      expectDate: "YYYY-mm-dd" // ÏôÑÎ£å Ìù¨ÎßùÏùº
  */

  async created () {
    this.setBreadCrumbs()

    // console.log(this.$route?.query)
    const { orderType, workState, roleIdx, useDoc, expectDate } = this.$route?.query
    this.useDoc = useDoc
    this.expectDate = expectDate.replace(/-/g, '.')
    this.getApprovalType({ orderType, workState, roleIdx, useDoc })
  },
  mounted () {
    // console.log()
    // this.$refs.pdfDownload.confirmForSavingPDF()
  },
  methods: {
    /**
     * Ï≤®Î∂ÄÌååÏùº Îã§Ïö¥Î°úÎìú
     * @param {Object} fileName
     */
    async fileDownload ({ fileName }) {
      try {
        const { approvalNo, approvalType } = this.data
        const params = { approvalNo, approvalType, fileName }
        const response = await API.work_v3.downloadAttachedFile(params)

        const url = window.URL.createObjectURL(new Blob([response.data], { type: response.headers['content-type'] }))
        const link = document.createElement('a')

        link.href = url
        link.setAttribute('download', fileName)
        document.body.appendChild(link)
        link.click()
      } catch (error) {
        console.error('@@ ApprovalBoxDetailDraft > fileDownload', error)
      }
    },

    async previewHandler (file) {
      if (this.reportName === file.name) {
        this.$refs.pdfDownload.confirmForSavingPDF()
      } else {
        console.log(file)
        const params = {
          approvalNo: this.approvalNo,
          fileName: file.name
        }
        const response = await API.work_v3.getReviewFile(params)
        const url = window.URL.createObjectURL(new Blob([response.data], { type: response.headers['content-type'] }))
        const link = document.createElement('a')

        link.href = url
        link.setAttribute('download', file.name)
        document.body.appendChild(link)
        link.click()
      }
    },
    handleExceed (files, fileList) {
      this.$alert('ÏµúÎåÄ 5Í∞ú ÌååÏùºÍπåÏßÄ ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.')
    },

    /**
     * ÎπµÍ∞ÄÎ£® Ï≤òÎ¶¨
     */
    setBreadCrumbs () {
      const { step, orderNo } = this.$route.params
      const label = {
        conference: this.$v('ÏÇ¨Ï†ÑÌòëÏùò'),
        todo: this.$v('Ìï† Ïùº')
      }[step]

      const elements = [label, `${this.$v('Ï£ºÎ¨∏Î≤àÌò∏')} ${orderNo}`]

      for (const key of elements) {
        this.$store.commit('common/ADD_PARAMETERS', {
          label: key,
          path: ''
        })
      }
    },

    /**
     * ÏõåÌÅ¨ÌîåÎ°úÏö∞Í∞Ä Ïñ¥ÎñªÍ≤å ÏÑ§Ï†ïÎêòÏñ¥ÏûàÎäêÎÉêÏóê Îî∞Îùº [Í≤∞Ïû¨ÏÑ† Î™©Î°ù], [Î≥¥Í≥†ÏÑú ÏÑ§Ï†ï] Îã§Î•¥Í≤å Ìò∏Ï∂ú
     */
    getApprovalType ({ orderType, workState, roleIdx, useDoc }) {
      // ÌòÑÏû¨ ÌéòÏù¥ÏßÄÏóê ÎßûÏ∂∞ÏÑú Í≤∞Ïû¨ÏÑ†ÏùÑ Í∞ÅÍ∞Å Îã§Î•¥Í≤å ÌôïÏù∏Ìï¥ÏïºÌï®!
      const workflowStep = {
        REVIEW: 'APPROVAL1', // [ÏÇ¨Ï†ÑÌòëÏùò] => Í≤∞Ïû¨1
        APPROVAL1_REJECTED: 'APPROVAL1', // [Í≤∞Ïû¨Ìï® > Í≤∞Ïû¨1 Î∞òÎ†§] => Ïû¨Í≤∞Ïû¨
        TODO_FINISHED: 'APPROVAL2', // [Ìï†Ïùº] => Í≤∞Ïû¨2
        APPROVAL2_REJECTED: 'APPROVAL2' // [Í≤∞Ïû¨Ìï® > Í≤∞Ïû¨2 Î∞òÎ†§] => Ïû¨Í≤∞Ïû¨
      }[workState]
      const workflowId = `-${orderType}-${workflowStep}-${roleIdx}`.toLowerCase()

      this.setWorkflowApprovers(workflowId)

      // [Î≥¥Í≥†ÏÑú ÏÑ§Ï†ï] ON/OFF Ïóê Îî∞Îùº ÏÉÅÏÑ∏ Îç∞Ïù¥ÌÑ∞Î•º Îã§Î•¥Í≤å Î∂àÎü¨ÏòµÎãàÎã§.
      // - ON  (true)   : ÏûëÏÑ±Ìïú Î≥¥Í≥†ÏÑú ÌÖúÌîåÎ¶ø Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
      // - OFF (false)  : Ïã†Ï≤≠Ìïú ÏûêÏõê Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ (readonly)
      return useDoc ? this.getReaOnlyDocument() : this.getReadOnlyResource()
    },

    /**
     * ÏõåÌÅ¨ÌîåÎ°úÏö∞Ïóê Ï†ÄÏû•Îêú Í≤∞Ïû¨ÏÑ† Ìò∏Ï∂ú
     * @param {String} workflowId
     */
    async setWorkflowApprovers (workflowId) {
      // workflow Ïóê Ï†ÄÏû•Îêú Í≤∞Ïû¨
      const { approvers } = await this.getWorkflowId(workflowId)
      this.approvers = approvers || []
    },

    /**
     * workflow ÌîÑÎ°úÏÑ∏Ïä§ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ìò∏Ï∂ú
     * @param {String} workflowId
     */
    async getWorkflowId (workflowId) {
      try {
        const response = await API.work_v3.getWorkflowId(workflowId)
        return response
      } catch (error) {
        console.error('@@ getWorkflowId', error)
        return []
      }
    },

    /**
     * Î≥¥Í≥†ÏÑú ÏÑ§Ï†ï ON ÏùºÎïå Ìò∏Ï∂ú
     * [ÏÇ¨Ï†ÑÌòëÏùò|Ìï†Ïùº > ÏûëÏóÖÍ≥ÑÌöçÏÑú|ÏôÑÎ£åÎ≥¥Í≥†ÏÑú > Î≥¥Í≥†ÏÑú ÏÉÅÏÑ∏ Ï°∞Ìöå]
     */
    async getReaOnlyDocument () {
      try {
        if (this.type === 'new') return

        const roleIdx = this.$route?.query?.roleIdx
        const orderNo = this.$route?.params?.orderNo
        const step = this.$route?.params?.step
        const workId = `${orderNo}-${roleIdx}`

        const orderType = this.$route?.query?.orderType
        const isUrgent = orderType === 'URGENT'

        const apiName = isUrgent
        // [ÏÇ¨Ï†ÑÌòëÏùò Í∏¥Í∏â] ÌéòÏù¥ÏßÄÏóêÏÑú Ï†ÄÏû•Îêú [ÏÇ¨ÌõÑÏôÑÎ£åÎ≥¥Í≥†ÏÑú] Ï°∞Ìöå
          ? 'getAADocument'
          : {
            conference: 'getReviewDocument', // [ÏÇ¨Ï†ÑÌòëÏùò] ÌéòÏù¥ÏßÄÏóêÏÑúÏùò Ï†ÄÏû•Îêú Î≥¥Í≥†ÏÑú
            todo: 'getTodoDocument' // [Ìï†Ïùº] ÌéòÏù¥ÏßÄÏóêÏÑúÏùò Ï†ÄÏû•Îêú Î≥¥Í≥†ÏÑú
          }[step]

        const { title, jsonData, lastModifiedAt } = await API.work_v3[apiName]({ workId })
        this.values = { name: title, text: jsonData }

        // ÌååÏùº ÏÑ∏ÌåÖ
        this.reportName = title + '_' + Dayjs(lastModifiedAt).format('YYYY-MM-DD')
        document.querySelector('.document-preview').innerHTML = jsonData
        this.fileList = [{ name: title + '_' + Dayjs(lastModifiedAt).format('YYYY-MM-DD') }]
      } catch (error) {
        console.error('@@ DocumentWorkDetail > getReaOnlyDocument', error)
      }
    },

    /**
     * Î≥¥Í≥†ÏÑú ÏÑ§Ï†ï OFF ÏùºÎïå Ìò∏Ï∂ú
     * [ÏÇ¨Ï†ÑÌòëÏùò|Ìï†Ïùº > ÏûêÏõê ÏÉÅÏÑ∏]
     */
    async getReadOnlyResource () {
      try {
        if (this.type === 'new') return

        const roleIdx = this.$route?.query?.roleIdx
        const workState = this.$route?.query?.workState
        const orderNo = this.$route?.params?.orderNo
        const workId = `${orderNo}-${roleIdx}`

        const workStep = {
          APPROVAL1_REJECTED: 'REVIEW', // Í≤∞Ïû¨ 1 ([ÏÇ¨Ï†ÑÌòëÏùò] Ìò∏Ï∂ú)
          APPROVAL2_REJECTED: 'TODO', // Í≤∞Ïû¨2 ([Ìï†Ïùº] Ìò∏Ï∂ú)
          TODO_FINISHED: 'TODO' // [Ìï†Ïùº] ÏôÑÎ£å ([Ìï†Ïùº] Ìò∏Ï∂ú)
        }[workState] || workState

        const data = await API.work_v3.getReadOnlyResource({ workId, workStep })
        this.orderList = [data] // Î¨¥Ï°∞Í±¥ Array ÌòïÏãù Ïù¥Ïñ¥ÏïºÌï® ...
      } catch (error) {
        console.error('@@ ApprovalApply > getReadOnlyResource', error)
      }
    },

    async setTask () {
      try {
        const validator = this.validator()
        if (!validator) return

        // Í≤∞Ïû¨ Ïã†Ï≤≠Ïûê
        const { company, group, approvee } = this.setApprovee()
        const { expectDate } = this.$route?.query

        const fileList = this.fileList.filter(f => f.name !== this.reportName)
        const formData = new FormData()

        const attachedFiles = []

        console.log('testFile')
        for (let i = 0; i < fileList.length; i++) {
          formData.append('file', fileList[i].raw)
          const data = await API.work_v3.saveReviewFile(formData)
          console.log('#url', data)
          attachedFiles.push({
            fileUrl: data.fileUrl,
            fileName: data.fileName
          })
        }

        const payload = {
          approvee,
          approveeCompany: company,
          approveeGroup: group,
          departId: group.idx, // Í≤∞Ïû¨ Ïã†Ï≤≠Ïûê Î∂ÄÏÑú Ïù∏Îç±Ïä§
          departName: group.name, // Í≤∞Ïû¨ Ïã†Ï≤≠Ïûê Î∂ÄÏÑú Ïù¥Î¶Ñ
          approvers: this.approvers, // Í≤∞Ïû¨Ïûê
          expectDate, // ÏôÑÎ£åÌù¨ÎßùÏùº
          attachFiles: attachedFiles,
          documentJson: JSON.stringify(this.values),
          reason: this.task.reason,
          title: this.task.name,
          orderNo: this.$route.params.orderNo,
          roleIdx: Number(this.$route.query.roleIdx),
          workId: {
            orderNo: this.$route.params.orderNo,
            roleIdx: Number(this.$route.query.roleIdx)
          },
          csp: this.cloud
        }

        console.log(payload, 'Í≤∞Ïû¨ ÏôÑÎ£å!')

        const step = this.$route?.params?.step
        const orderType = this.$route?.query?.orderType

        const isUrgent = orderType === 'URGENT' // [Í∏¥Í∏â] Í±¥ ÏùºÎïå

        const apiName = {
          conference: isUrgent ? 'applyAAReportApproval' : 'applyReviewApproval', // [ÏÇ¨Ï†ÑÌòëÏùò] ÌéòÏù¥ÏßÄÏóêÏÑúÏùò Ï†ÄÏû•Îêú Î≥¥Í≥†ÏÑú
          todo: 'applyTodoApproval' // [Ìï†Ïùº] ÌéòÏù¥ÏßÄÏóêÏÑúÏùò Ï†ÄÏû•Îêú Î≥¥Í≥†ÏÑú
        }[step]

        await API.work_v3[apiName](payload)

        this.$alert(this.$v('Í≤∞Ïû¨Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.'), { callback: () => this.$router.go(-1) })
      } catch (error) {
        this.catchMessage(error, this.$v('Í≤∞Ïû¨Í∞Ä Ïã†Ï≤≠ÏùÑ ÏßÑÌñâÌïòÎäîÎèôÏïà Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌïòÏòÄÏäµÎãàÎã§. <br> Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.'))
        console.error('@@ ApprovalApply > setTask', error)
      }
    },

    /**
     * Í≤∞Ïû¨ Ï†Ñ ÌïÑÏàòÍ∞í ÌôïÏù∏
     * @return {Boolean}
     */
    validator () {
      const conditions = [
        { condition: this.task.name, message: this.$v('Í≤∞Ïû¨ Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.') },
        { condition: this.approvers.length > 0, message: this.$v('Í≤∞Ïû¨ÏûêÎ•º ÏßÄÏ†ïÌï¥Ï£ºÏÑ∏Ïöî.') },
        { condition: this.task.reason, message: this.$v('Í≤∞Ïû¨ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.') }
        // { condition: true, message: this.$v('') },
      ]

      // [Í≤∞Ïû¨ ÏÇ¨Ïö© ON] Ïù¥ÎùºÎ©¥ Í≤∞Ïû¨ ÌååÏùº ÌïÑÏàò
      if (this.useDoc) conditions.push({ condition: this.fileList.length > 0, message: this.$v('Í≤∞Ïû¨ ÌååÏùºÏùÑ ÌïòÎÇò Ïù¥ÏÉÅ Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî.') })

      return conditions.every(({ condition, message }) => {
        if (!condition) this.$alert(message)
        return condition
      })
    },

    /**
     * [Í≤∞Ïû¨ÏÑ† ÏÑ§Ï†ï] Ï†ÄÏû•
     * @param {Array} approvers ÏÑ†ÌÉùÎêú Í≤∞Ïû¨ÏÑ† Îç∞Ïù¥ÌÑ∞
     */
    saveApprovers (approvers) {
      const result = approvers.map(({ userId, userName, userPosition, companyName, groupName, no, type }) => {
        return {
          no,
          type,
          approver: { id: userId, name: userName, position: userPosition },
          company: { idx: null, name: companyName },
          userGroup: { idx: null, name: groupName }
        }
      })

      this.approvers = result
    },

    /**
     * ÌòÑÏû¨ Í≤∞Ïû¨ÌïòÍ≥†ÏûàÎäî [Ï£ºÎ¨∏Ïûê(=Í≤∞Ïû¨Ïã†Ï≤≠Ïûê)] Ï†ïÎ≥¥ Í∞ÄÍ≥µ
     */
    setApprovee () {
      const {
        userCompanyCode, userCompany, userCompanyName,
        userDuty, userId, userIdx, userName, userPosition,
        userGroupCode, userGroup: groupIdx, userGroupName
      } = this.user

      // [Ï£ºÎ¨∏Ïûê (=Í≤∞Ïû¨Ïã†Ï≤≠Ïûê)] Ï†ïÎ≥¥ ÏÑ∏ÌåÖ
      const company = { code: userCompanyCode, idx: userCompany, name: userCompanyName, ownerIdx: 1004, ownerName: 'randomValue' }
      const group = { code: userGroupCode, idx: groupIdx, name: userGroupName }
      const approvee = { duty: userDuty || 'randomValue', id: userId, idx: userIdx, name: userName, position: userPosition }

      return { company, group, approvee }
    },

    /**
     * [Í≤∞Ïû¨ÏÑ† ÏÑ†ÌÉù] Î™®Îã¨Î°ú ÏÑ†ÌÉùÌïú Í≤∞Ïû¨Ïûê Î™©Î°ù Í∞ÄÍ≥µ
     */
    setApprovers (userList) {
      // [Í≤∞Ïû¨Ïûê] Î™©Î°ù ÏßÄÏ†ï
      const approvers = []
      for (let i = 0; i < userList.length; i++) {
        const {
          no, type, // isDrafter,
          userDuty, userId, userName, userPosition,
          userCompanyCode, userCompany, userCompanyName,
          userGroupCode, userGroup, userGroupName
        } = userList[i]

        approvers.push({
          no, // Í≤∞Ïû¨ Îã¥ÎãπÏûê ÏàúÎ≤à
          type, // Ìï©Ïùò, Í≤∞Ïû¨
          approver: { duty: userDuty || 'randomValue', id: userId, name: userName, position: userPosition }, // Í≤∞Ïû¨ Îã¥ÎãπÏûê Ïú†Ï†Ä Ï†ïÎ≥¥
          approverCompany: { code: userCompanyCode, idx: userCompany || '????', name: userCompanyName, ownerIdx: 1004, ownerName: 'randomValue' }, // Í≤∞Ïû¨ Îã¥ÎãπÏûê Í¥ÄÍ≥ÑÏÇ¨ Ï†ïÎ≥¥
          approverGroup: { code: userGroupCode, idx: userGroup || '????', name: userGroupName } // Í≤∞Ïû¨ Îã¥ÎãπÏûê Ï°∞ÏßÅ Ï†ïÎ≥¥
        })
      }

      return approvers
    },
    /**
     * textarea ÌÖçÏä§Ìä∏ ÏûÖÎ†•ÏãúÎßàÎã§ ÏòÅÏó≠ ÎÜíÏù¥ ÏÑ§Ï†ï
     * @param {EventObject} e
     */
    ctrlTextAreaSize (e) {
      const textareaWrap = this.$refs.textarea.$el
      const textarea = textareaWrap.querySelector('textarea')

      textarea.style.height = 'auto'
      textarea.style.height = textarea.scrollHeight + 'px'
      textareaWrap.style.height = textarea.scrollHeight + 'px'
    },
    /**
     * Í≤∞Ïû¨ Ïã†Ï≤≠ Î≤ÑÌäº ÌÅ¥Î¶≠Ïãú Î∞úÏÉùÌïòÎäî Ïù¥Î≤§Ìä∏
     * ÌïÑÏàòÍ∞í validator
     * @param {Object} data Í≤∞Ïû¨ Ï†ïÎ≥¥
     */
    validateToSendApproval (data = this.task) {
      const keys = Object.keys(data)
      const valid = keys.filter(key => {
        const validKeys = ['name', 'finishTime', 'reason']
        return validKeys.includes(key)
      })

      const checkData = valid.map(key => data[key].trim())
      const checkValue = checkData.every(val => val)
      return checkValue
    },
    fileOnChange (file, fileList) {
      console.log('#fileOnChange', file)

      if (file.size >= (1024 * 1024 * 10)) { // 10Mb Ïù¥Ìïò ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•
        this.fileList = this.fileList.filter(x => x.uid !== file.uid) // Ìï¥ÎãπÌïòÎäî
        setTimeout(() => {
          this.$alert(this.$t('common.ALERT.PROJECT.081', { size: '10Mb', fileName: file.name }))
        }, 0)
        console.log(111, this.fileList)
      } else {
        this.fileList.push(file)
        console.log(222, this.fileList)
      }
    },
    fileBeforeDelete (file, fileList) {
      this.fileList = this.fileList.filter(x => x.uid !== file.uid) // Ìï¥ÎãπÌïòÎäî
    }
  },
  data () {
    return {
      loading: false,
      reportName: '',
      values: {},
      approvers: [],
      useDoc: false,
      expectDate: undefined,
      rawData: [],
      orderList: [], // Ï£ºÎ¨∏Ìïú ÎÇ¥Ïó≠
      task: {
        name: '',
        reason: '',
        oldTaskNo: '',
        companyId: '',
        companyName: '',
        groupId: '',
        groupName: '',
        userId: '',
        userName: '',
        userPosition: '',
        departId: '',
        departName: '',
        finishTime: '',
        orders: [],
        approvals: []
      },
      fileList: [],
      blsmModal: false,

      /**
       * ÏÑ†ÌÉùÎêú Í≤∞Ïû¨ÏÑ† Ïπ¥Ïö¥Ìä∏
       */
      approverTags (approvers) {
        if (approvers.length === 0) return null

        const userName = approvers[0].approver.name
        return approvers.length > 1 ? `${userName} Ïô∏ ${approvers.length - 1}` : userName
      }
    }
  }
}
</script>
<style lang="scss" scoped>
.button-area {
  margin: $gap-m 0;
}

.document-preview {
  // border: 1px solid red;
}

.approval-apply {
  &::v-deep {
    .cmp-upload {
      .el-upload-list {
        :first-child {
          .el-icon-close {
            display: none;
          }
        }
      }

      &.is-disabled {
        .el-upload--text {
          display:none;
        }
        .el-upload-list {
           .el-icon-close {
              display: none;
            }
        }
      }
    }
  }
}
</style>
