
<template>
  <div v-loading="loading">
    <div class="flex-wrap -space-between">
      <filtering-component
        v-if="filteringOptions.length"
        :data="filteringOptions"
        @selected="filterAction"
        @reset-data="filterRest"
      />

      <button
        class="button"
        type="is-primary"
        @click="viewInstallhistory = true"
      >
        {{ $v('Script Ïã§Ìñâ Ïù¥Î†•Ï°∞Ìöå') }}
      </button>
    </div>

    <section class="detail-wrapper">
      <article>
        <div class="sw-version-info">
          <div class="-name">
            <h6>{{ $route.params.name }}</h6>
            <small v-if="installableVersionCount > 0">
              <!-- Ïã†Í∑ú SW Ï∂îÍ∞Ä {{ installableVersionCount }}Í±¥ -->
              {{ $t('service.INSTALL.newSWCnt', { count: installableVersionCount }) }}
            </small>
          </div>

          <button
            class="button"
            type="is-primary"
            @click="updateProgram('versionAdd', `ÏÑ§ÏπòÌîÑÎ°úÍ∑∏Îû® Î≤ÑÏ†Ñ Ï∂îÍ∞Ä`)"
          >
            {{ $v('Î≤ÑÏ†Ñ Ï∂îÍ∞Ä') }}
          </button>
        </div>
        <!-- /. SW Ï†ïÎ≥¥, Î≤ÑÏ†Ñ Ï∂îÍ∞Ä  -->

        <search-bar
          :user-reset-icon="false"
          size="mini"
          @input="val => { if(!val) init() }"
          @change="changeText"
          :placeholder="$t('common.ALERT.SERVICE.019')"
        />
        <!-- /. Í≤ÄÏÉâÏòÅÏó≠ -->

        <ul
          class="versions"
          v-if="swVersions.length"
        >
          <li
            v-for="(item, idx) in swVersions"
            :key="idx"
            :class="['-item', selectedVersion && selectedVersion.id === item.id ? '-selected' : '']"
            @click="clickVersion(item)"
          >
            <span :class="['status', item.statusName.css]" />
            <div class="-info">
              <b class="name">
                <span
                  v-if="setNewTag(item.createDate)"
                  class="new"
                >N</span>
                Ver {{ item.version }}
                <!-- // üå∏ {{ item.id }} -->
              </b>

              <strong class="info type">{{ item.osName }}</strong>
              <strong class="info bit">{{ item.bit }} bit</strong>
            </div>

            <el-tooltip
              effect="light"
              placement="right"
              popper-class="edit-modal-popper"
            >
              <i
                class="mdi mdi-dots-vertical"
                @mouseenter="item.edit = true"
              />
              <template #content>
                <p @click="updateProgram('versionUpdate', `S/W ${$t('common.BTN.change')}`, item)">
                  {{ $v('Î≥ÄÍ≤Ω') }}
                </p>
                <p @click="setDeleteSW(true, item)">
                  {{ $v('ÏÇ≠Ï†ú') }}
                </p>
              </template>
            </el-tooltip>
            <!-- /. ÏàòÏ†ï/ÏÇ≠Ï†ú ÏÑ§Ï†ï -->
          </li>
        </ul>

        <div
          class="versions -empty"
          v-else
        >
          {{ $t('common.PLACEHOLDER.noData') }}
        </div>
      </article>
      <!-- /. LEFT - ÏÜåÌîÑÌä∏Ïõ®Ïñ¥ Î≤ÑÏ†Ñ Î¶¨Ïä§Ìä∏ -->

      <article v-if="selectedVersion !== null">
        <!-- ÎîîÎ≤ÑÍπÖ ~ üå∏ {{ selectedVersion }} -->
        <div class="detail-description-wrapper">
          <div class="detail-description">
            <h5 class="-title">
              <span
                v-if="setNewTag(selectedVersion.createDate)"
                style="margin-right: 8px"
                class="new"
              >N</span>
              Ver {{ selectedVersion.version }}

              <small v-if="selectedVersion.usableScript">
                {{ $t('service.INSTALL.usingScriptVer') }} : v{{ selectedVersion.swScriptVersion }}
              </small>
              <small v-else>
                <!-- ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïä§ÌÅ¨Î¶ΩÌä∏ Î≤ÑÏ†ÑÏù¥ ÏóÜÏäµÎãàÎã§. -->
                {{ $t('service.INSTALL.ALERT.014') }}
              </small>
            </h5>

            <div class="version-desc-buttons">
              <small>
                <strong class="info type">{{ selectedVersion.osName }}</strong>
                <strong class="info bit">{{ selectedVersion.bit }} bit</strong>
              </small>
            </div>

            <textarea
              class="description tiny-scroll"
              readonly
              :placeholder="$v(`Ver ${selectedVersion.version}Ïùò Îì±Î°ùÎêú ÏÑ§Î™ÖÏù¥ ÏóÜÏäµÎãàÎã§.`)"
              v-model="selectedVersion.desc"
            />
          </div>
          <!-- /. Î≤ÑÏ†Ñ ÏÉÅÏÑ∏ ÏÑ§Î™Ö -->
        </div>
        <!-- /. Î≤ÑÏ†Ñ ÏÑ§Î™Ö -->

        <g-tab :data="tabData">
          <template #manageProgram>
            <install-vm-list />
          </template>
          <!-- /. VM Î≥Ñ ÏÑ§ÏπòÌîÑÎ°úÍ∑∏Îû® Í¥ÄÎ¶¨ -->

          <template #manageScript>
            <article class="script-version-list-wrapper">
              <div
                class="flex-wrap -space-between"
                style="margin-bottom: 15px;"
              >
                <h5 class="-title">
                  <!-- ÏÑ§ÏπòÏä§ÌÅ¨Î¶ΩÌä∏ Í¥ÄÎ¶¨ -->
                  {{ $t('service.INSTALL.manageScript') }}
                </h5>
                <button
                  class="button"
                  type="is-primary"
                  @click="$router.push({ name: 'install-program-script', params: { versionId: selectedVersion.id } })"
                >
                  <!-- Ïä§ÌÅ¨Î¶ΩÌä∏ Î≤ÑÏ†Ñ Ï∂îÍ∞Ä -->
                  {{ $t('service.INSTALL.addScriptVer') }}
                </button>
              </div>

              <div>
                <!-- :item-source="selectedVersion.scriptList" -->
                <cmp-grid
                  :item-source="installScriptData"
                  :columns="installScriptColumn"
                  :use-column-filter="false"
                  :paging-size="5"
                >
                  <template #statusName="{ row }">
                    <el-tooltip
                      effect="light"
                      placement="bottom"
                      :disabled="row.statusName !== 'FAILED'"
                    >
                      <span :class="['simulation', row.statusName.css ]">
                        {{ row.statusName.name }}
                      </span>

                      <div slot="content">
                        Ïã§Ìå® ÏÇ¨Ïú†
                      </div>
                    </el-tooltip>
                  </template>
                  <!-- /. ÏãúÎÆ¨Î†àÏù¥ÏÖò -->

                  <template #script="{ row }">
                    <ul class="script-types flex-wrap">
                      <li
                        v-for="s in scriptTypes"
                        :key="s.label"
                        @click="$router.push({
                          name: s.routeTo,
                          query: {scriptId: row.id, ...s.query },
                          params: { versionId: selectedVersion.id }
                        })"
                      >
                        {{ s.label }}
                      </li>
                    </ul>
                  </template>
                  <!-- /. Ïä§ÌÅ¨Î¶ΩÌä∏ -->

                  <template #isUsing="props">
                    <el-switch
                      class="using-switch"
                      v-model="props.row.isUse"
                      @change="changeInstallScriptUsage(props.row)"
                    />
                    <!-- <el-select
                      v-model="props.row.isUse"
                      placeholder="ÏÇ¨Ïö©Ïó¨Î∂Ä"
                      :popper-append-to-body="true"
                      @change="changeInstallScriptUsage(props.row)"
                    >
                      <el-option
                        v-for="type in isUsingOption"
                        :key="type.value"
                        :label="type.label"
                        :value="type.value"
                      />
                    </el-select> -->
                  </template>
                  <!-- /. ÏÇ¨Ïö©Ïó¨Î∂Ä -->

                  <template #fn="{ row }">
                    <div class="function-icons">
                      <i
                        class="-edit-icon"
                        @click="$router.push({
                          name: 'install-program-script',
                          params: { versionId: selectedVersion.id },
                          query: { scriptId: row.id }
                        })"
                      />
                      <i
                        class="-delete-icon"
                        @click="setDeleteScript(true, row)"
                      />
                    </div>
                  </template>
                </cmp-grid>
              </div>
            </article>
          </template>
          <!-- /. ÏÑ§ÏπòÏä§ÌÅ¨Î¶ΩÌä∏ Í¥ÄÎ¶¨ Î™©Î°ù -->
        </g-tab>
      </article>
      <!-- /. RIGHT - ÏÑ§ÏπòÏä§ÌÅ¨Î¶ΩÌä∏ ÏÉÅÏÑ∏ -->

      <article
        v-else
        class="empty"
      >
        <!-- ÏÜåÌîÑÌä∏Ïõ®Ïñ¥ Î≤ÑÏ†ÑÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî. -->
        {{ $t('service.INSTALL.ALERT.015') }}
      </article>
    </section>
    <!-- /. ÏÉÅÏÑ∏ -->

    <!-- //////////// -->
    <!-- //// Î™®Îã¨ /// -->
    <!-- //////////// -->
    <install-program-history
      :visible="viewInstallhistory"
      @close="viewInstallhistory = false"
      :title="`Script Ïã§Ìñâ Ïù¥Î†•Ï°∞Ìöå :: ${$route.params.name}`"
      width="1450px"
      top="50px"
    />
    <!-- /. Script Ïã§Ìñâ Ïù¥Î†•Ï°∞Ìöå Î™®Îã¨ -->

    <install-program-version-update
      :visible="setSwModal.visible"
      :type="setSwModal.type"
      :title="setSwModal.title"
      :data="setSwModal.data"
      width="1100px"
      top="50px"
      @close="setSwModal.visible = false"
      @update="updateSwAction"
    />
    <!-- /. [SW Î≤ÑÏ†Ñ] ÏàòÏ†ïÎ™®Îã¨ -->

    <install-program-delete
      :status="deleteSwModal"
      @delete="deleteSW"
    />
    <!-- /. [SW Î≤ÑÏ†Ñ] ÏÇ≠Ï†ú Î™®Îã¨ -->

    <install-program-update-file
      :visible="setFileModal.visible"
      :title="setFileModal.title"
      :data="setFileModal.data"
      :type="setFileModal.type"
      width="360px"
      top="50px"
      @update="refreshVersion"
      @upload-status="val => fileUploading = val"
      @close="() => fileUploading ? null : setFileModal.visible = false"
    />
    <!-- /. [ÏÑ§Ïπò ÌååÏùº] Ï∂îÍ∞Ä -->

    <install-program-delete
      :status="deleteScriptModal"
      @delete="deleteScript"
    />
    <!-- /. [ÏÑ§ÏπòÏä§ÌÅ¨Î¶ΩÌä∏] ÏÇ≠Ï†ú Î™®Îã¨ -->
  </div>
</template>

<script>
import API, { FilteringComponent } from '@sd-fe/cmp-core'
import InstallProgramHistory from '../InstallProgramLists/InstallProgramHistory'
import SearchBar from '@/components/SearchBar/SearchBar'
import InstallProgramVersionUpdate from '../InstallProgramConfig/InstallProgramVersionUpdate'
import InstallProgramUpdateFile from '../InstallProgramConfig/InstallProgramUpdateFile'
import InstallProgramDelete from '../InstallProgramConfig/InstallProgramDelete'
import { mapState } from 'vuex'
import InstallVMList from './InstallVMList.vue'

export default {
  name: 'InstallProgramDetail',
  components: {
    'filtering-component': FilteringComponent,
    'install-program-history': InstallProgramHistory,
    'search-bar': SearchBar,
    'install-program-version-update': InstallProgramVersionUpdate,
    'install-program-update-file': InstallProgramUpdateFile,
    'install-program-delete': InstallProgramDelete,
    'install-vm-list': InstallVMList
  },
  computed: {
    ...mapState({
      user: state => state.auth.user
    })
  },
  watch: {
    selectedVersion (version) {
      if (!version) return

      if (version.usableScript) version.swScriptVersion = version.version + '.' + version.usableScript.scriptVersion

      // this.installFileData = this.setInstallFileData(version)  // ‚ùå ÏÑ§ÏπòÌååÏùº Í¥ÄÎ¶¨Í∞Ä Ïù¥Ï†úÎäî ÏóÜÏñ¥Ï°åÏùå
      this.installScriptData = this.setInstallScriptData(version)
    }
  },
  async created () {
    console.clear()

    // breadcrumbs
    this.setVersionBreadcrumb()

    const osTypes = await this.getOsTypesGroup()

    // OS ÌïÑÌÑ∞ ÏÑ∏ÌåÖ
    this.filteringOptions[0].selections = osTypes
    this.osTypes = this.setOsTypeFinder(osTypes)

    this.init()
  },
  methods: {
    /**
     * ÌôîÎ©¥ Ï¥àÍ∏∞Ìôî~
     * @param { Object } param ÌäπÏ†ï Ï°∞Í±¥ÏúºÎ°ú ÌïÑÌÑ∞ÎßÅÏùÑ Ìïú Î≤ÑÏ†Ñ Î™©Î°ùÏùÑ Í∞ÄÏ†∏Ïò§Í∏∞ ÏúÑÌï¥ ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§
     */
    async init (param) {
      this.loading = true
      this.rawData = await this.getVersionLists(this.$route.params.idx, param)
      await this.getSwInfo(this.$route.params.idx)

      console.log(this.rawData, 'init rawData')
      this.swVersions = await this.setVersionsFormat(this.rawData)

      // ÏûêÎèôÏúºÎ°ú version ÏÑ†ÌÉùÌïòÍ∏∞
      if (this.$route.query?.version) {
        const versionIdx = Number(this.$route.query?.version)

        this.swVersions.forEach(version => {
          if (version.id === versionIdx) {
            this.selectedVersion = version
            return false
          }
        })
      }

      this.loading = false
    },

    /**
     * ÌòÑÏû¨ [ÏÑ†ÌÉùÎêú SW] Ïùò ÏÉÅÏÑ∏ Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏ÏòµÎãàÎã§.
     */
    async getSwInfo (id) {
      try {
        const version = await API.sw.getSwInfo(id)
        this.installableVersionCount = version.newLicenseCnt
      } catch (error) {
        this.loading = false
        console.error('@@ getSwInfo: ', error)
        this.installableVersionCount = 0
      }
    },

    /**
     * [ÏßÄÏõê OS] ÏòµÏÖò Î™©Î°ù ÏÑ∏ÌåÖ (Í≤ÄÏÉâ ÌïÑÌÑ∞Ïö©)
     * { 20: { label: 'Windows', value: 20 }, ... } ÌòïÏãùÏúºÎ°ú Ï†ÄÏû•Ìï©ÎãàÎã§.
     */
    async getOsTypesGroup () {
      try {
        this.loading = true
        const response = await API.enum.getOsTypeGroup()
        return response.map(({ codeVal, codeIdx }) => ({ label: codeVal, value: codeVal }))
      } catch (error) {
        console.error('@@ getOsTypesGroup: ', error)
        return []
      } finally {
        this.loading = false
      }
    },

    /**
     * [ÏßÄÏõê OS] Î•º index Î°ú ÌåêÎ≥ÑÌïòÍ∏∞ ÏúÑÌï¥ ÏÑ∏ÌåÖ
     * @param { Array } osTypes getOsTypesÎ°ú Í∞ÄÏ†∏Ïò® Îç∞Ïù¥ÌÑ∞
     */
    setOsTypeFinder (osTypes) {
      const object = {}
      osTypes.forEach(({ label, value }) => { object[value] = { label, value } })
      return object
    },

    // -------------------------------------------------------------
    // ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã [Î≤ÑÏ†Ñ] ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã
    // -------------------------------------------------------------

    /**
     * ÏÑ§ÏπòÌîÑÎ°úÍ∑∏Îû® ÌîÑÎ°úÍ∑∏Îû®Î™Ö breadcrumb ÏÑ∏ÌåÖ
     */
    setVersionBreadcrumb () {
      this.$store.commit('common/ADD_PARAMETERS', {
        label: this.$route.params.name,
        path: ''
      })
    },

    /**
     * ÌòÑÏû¨ SWÏùò [Ï¢åÏ∏° version Î™©Î°ù]ÏùÑ Î∂àÎü¨ÏòµÎãàÎã§
     * @param { Number } idx Ìï¥Îãπ ÌîÑÎ°úÍ∑∏Îû®Ïùò index
     */
    async getVersionLists (idx = this.$route.params.idx, param) {
      try {
        const response = await API.sw.getVersionLists(idx, param)
        return response
      } catch (error) {
        this.loading = false
        console.error('@@ getVersionLists: ', error)
        return []
      }
    },

    /**
     * [Ï¢åÏ∏° version Î™©Î°ù]Ïùò ÌòïÏãùÏùÑ Í∞ÄÍ≥µÌï©ÎãàÎã§.
     * @param { Array } data rawData Î•º Ìè¨Ìï®Ìï©ÎãàÎã§.
     */
    async setVersionsFormat (data) {
      return data.map(({ version, bitType, osType, status, description, isUse, ...item }) => {
        return {
          ...item,
          version,
          osType,
          bit: bitType,
          osName: osType,
          statusName: this.simulationStatus[status || 'UNEXECUTED'],
          desc: description
        }
      })
    },

    /**
     * [SW Î≤ÑÏ†Ñ] Ï∂îÍ∞Ä / ÏàòÏ†ï
     * [Ï∂îÍ∞Ä] type: 'add', title: 'S/W Ï∂îÍ∞Ä'
     * [ÏàòÏ†ï] type: 'update', title: 'S/W Î≥ÄÍ≤Ω'
     */
    updateProgram (type, title, item = null) {
      this.setSwModal = {
        visible: true,
        type,
        title,
        data: item
      }
    },

    // ===============================
    // ========= [SW Î≤ÑÏ†Ñ Ï∂îÍ∞Ä] ========
    // ===============================

    /**
     * [SW Ï∂îÍ∞Ä] Ïãú payload Î•º Ï†ïÏùòÌï©ÎãàÎã§.
     * @param { Object } items Î≥ÄÍ≤ΩÎêú Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†•
     */
    addSw ({ version, desc, osSystem, osType, osVersion, osBits, swList, isDisplay, installType, ...items }) {
      const softwareId = Number(this.$route.params.idx) // Ï†ÄÏû•ÌïòÍ∏∞ ÏúÑÌï¥ÏÑ† Ìï¥Îãπ [ÏÑ§ÏπòÌîÑÎ°úÍ∑∏Îû®] Ïùò id Î•º softwareId ÌÇ§Î°ú ÌïÑÏöîÎ°úÌï©ÎãàÎã§.

      const payload = {
        version,
        softwareId,
        osSystem,
        osType,
        osVersion,
        isDisplay,
        installType,
        bitType: osBits,
        description: desc,
        swList
      }

      // console.log(payload, swList)
      return this.addSwVersion(payload)
    },
    /**
     * [SW Ï∂îÍ∞Ä] API Ï†ïÏùò
     * ÎèôÏùºÌïú Ï°∞Í±¥(SW ÎùºÏù¥ÏÑ†Ïä§, ÏßÄÏõê OS, OS bits)Ïóê Îì±Î°ùÌïòÎäîÍ≤ΩÏö∞ Ï∞®Îã®
     * ÎèôÏùºÌïú SW ÎùºÏù¥ÏÑ†Ïä§ Î∞ëÏóê ÏßÄÏõêÌïòÎäî Îã§Î•∏ OS Î•º ÏÑ§Ï†ïÌïú Í≤ΩÏö∞Îäî Ìï¥Îãπ SW ÎùºÏù¥ÏÑ†Ïä§ versionList ÏïÑÎûòÎ°ú Îì§Ïñ¥Í∞ê
     */
    async addSwVersion (payload) {
      try {
        await API.sw.addSwVersion(payload)
        this.refreshVersion()
        this.setSwModal.visible = false
      } catch (error) {
        console.error('@@ addSwVersion : ', error)
        // SW Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. <br> Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî
        this.$alert(this.$t('service.INSTALL.ALERT.006'), '', { dangerouslyUseHTMLString: true, callback: () => false })
      }
    },

    // ===============================
    // ========= [SW Î≤ÑÏ†Ñ Î≥ÄÍ≤Ω] ========
    // ===============================

    /**
     * [SW Î≤ÑÏ†Ñ Î≥ÄÍ≤Ω] Ïãú payload Î•º Ï†ïÏùòÌï©ÎãàÎã§.
     * @param { Object } items Î≥ÄÍ≤ΩÎêú Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†•
     */
    updateSw ({ id, version, desc, osSystem, osType, osVersion, osBits, swList, isDisplay, installType, ...items }) {
      const softwareId = Number(this.$route.params.idx) // Ï†ÄÏû•ÌïòÍ∏∞ ÏúÑÌï¥ÏÑ† Ìï¥Îãπ [ÏÑ§ÏπòÌîÑÎ°úÍ∑∏Îû®] Ïùò id Î•º softwareId ÌÇ§Î°ú ÌïÑÏöîÎ°úÌï©ÎãàÎã§.

      const payload = {
        id,
        version,
        softwareId,
        osSystem,
        osType,
        osVersion,
        isDisplay,
        installType,
        bitType: osBits,
        description: desc,
        swList
      }

      // console.log(payload)
      return this.updateSwVersion(payload)
    },

    /**
     * [SW Î≥ÄÍ≤Ω] API Ï†ïÏùò
     */
    async updateSwVersion (payload) {
      try {
        await API.sw.updateSwVersion(payload)
        this.refreshVersion()
        this.setSwModal.visible = false
      } catch (error) {
        console.error('@@ updateScript : ', error)
        // SW Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. <br> Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî
        this.$alert(this.$t('service.INSTALL.ALERT.007'), '', { dangerouslyUseHTMLString: true, callback: () => false })
      }
    },
    /**
     * [SW Î≥ÄÍ≤Ω] API Ï†ïÏùò
     */
    async updateScript (payload) {
      try {
        await API.sw.updateScript(payload)
        this.refreshVersion()
        this.setSwModal.visible = false
      } catch (error) {
        console.error('@@ updateScript : ', error)
        // SW Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. <br> Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî
        this.$alert(this.$t('service.INSTALL.ALERT.007'), '', { dangerouslyUseHTMLString: true, callback: () => false })
      }
    },

    // ===============================
    // ========= [SW Î≤ÑÏ†Ñ ÏÇ≠Ï†ú] ========
    // ===============================

    /**
     * [SW Î≤ÑÏ†Ñ] ÏÇ≠Ï†úÏãú ÏÑ∏ÌåÖ
     */
    setDeleteSW (status, item = null) {
      this.deleteSwModal = {
        visible: status,
        item,
        value: undefined,
        disabled: true,
        name: `${this.$route.params.name}` // ÏÇ≠Ï†úÏãú ÏûÖÎ†•Ìï† Ïù¥Î¶Ñ
      }
    },

    /**
     * [SW Î≤ÑÏ†Ñ] ÏÇ≠Ï†ú
     * ÏÇ≠Ï†ú ÏãúÏóêÎäî true Î•º ÎÇ¥Î≥¥ÎÇ¥Ï£ºÏñ¥ Ïï°ÏÖòÏùÑ Ï∑®ÌïòÍ≥†,
     * ÏïÑÎãêÍ≤ΩÏö∞ÏóêÎäî Í∑∏ÎÉ• ÏÇ≠Ï†ú Î™®Îã¨ close Îßå Ìï©ÎãàÎã§.
     */
    async deleteSW (action) {
      if (action === true) {
        const response = await API.sw.deleteSwVersion(this.deleteSwModal.item.id)
        if (response) {
          // `${this.deleteSwModal.name}(Ïù¥)Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.
          this.$alert(this.$t('service.INSTALL.ALERT.005', { name: this.deleteSwModal.name }), {
            callback: () => this.refreshVersion()
          })
        }
      }
      return this.setDeleteSW(false)
    },

    // ==========================
    // ========== [Í≥µÏö©] =========
    // ==========================

    /**
     * [SW Î≤ÑÏ†Ñ Ï∂îÍ∞Ä / ÏàòÏ†ï] Î≤ÑÏ†Ñ Î≥ÄÍ≤ΩÏãú Î∞úÏÉùÌïòÎäî Ïù¥Î≤§Ìä∏ Ìï∏Îì§ÎßÅ
     */
    updateSwAction (item) {
      const type = {
        versionAdd: () => this.addSw(item),
        versionUpdate: () => this.updateSw(item)
      }

      return type[this.setSwModal.type]()
    },

    /**
     * Í∞±Ïã† ÌõÑ ÌôîÎ©¥ÏùÑ ÏÉàÎ°úÍ≥†Ïπ®Ìï©ÎãàÎã§.
     */
    async refreshVersion () {
      await this.init()
      if (this.selectedVersion === null) return

      const versionIdx = this.selectedVersion.id
      this.selectedVersion = null

      this.swVersions.forEach(version => {
        if (version.id === versionIdx) {
          this.selectedVersion = version
          return false
        }
      })
    },

    /**
     * Î≤ÑÏ†Ñ ÌÅ¥Î¶≠Ïãú Î∞úÏÉùÌïòÎäî Ïù¥Î≤§Ìä∏ÏûÖÎãàÎã§
     * @param { Object } item ÏÑ†ÌÉùÌïú Î≤ÑÏ†Ñ
     */
    clickVersion (item) {
      if (this.selectedVersion && this.selectedVersion.id === item.id) return

      this.selectedVersion = item
      this.$router.replace({ query: { version: this.selectedVersion.id } })
      this.setVersionBreadcrumb()
    },

    /**
     * [Í≤ÄÏÉâ] Ïã§ÌñâÏãú ÎèôÏûëÌï©ÎãàÎã§
     */
    async changeText (value) {
      this.params = { ...this.params, version: value }
      this.init(this.params)
    },
    filterAction (values) {
      this.params = { ...this.params, ...values }
      this.init(this.params)
    },
    filterRest (values) {
      this.params = {}
      this.init(this.params)
    },

    // -------------------------------------------------------------
    // ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã [ÏÑ§Ïπò ÌååÏùº Í¥ÄÎ¶¨] ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã
    // -------------------------------------------------------------

    /**
     * [ÏÑ§Ïπò ÌååÏùº Í¥ÄÎ¶¨] Î™©Î°ù ÏÑ∏ÌåÖ
     */
    setInstallFileData (version) {
      const date = date => this.$options.filters.date(date, 'YYYY.MM.DD')
      const size = byte => this.$options.filters.byte(byte)
      const masking = name => this.$options.filters.maskingName(name)

      return version?.fileList.map((file, idx) => {
        const user = (file.createUserName && file.createUserId) ? file.createUserName + ' (' + masking(file.createUserId) + ')' : '-'
        const result = {
          ...file,
          order: idx + 1,
          createDate: date(file.createDate),
          fileName: file.originalName,
          user,
          size: size(file.size)
        }
        return result
      })
    },
    /**
     * [ÏÑ§Ïπò ÌååÏùº] Ï∂îÍ∞Ä/ÏàòÏ†ï
     * [Ï∂îÍ∞Ä] type: 'add', title: 'ÌååÏùº Ï∂îÍ∞Ä'
     * [Ï∂îÍ∞Ä] type: 'update', title: 'ÌååÏùº ÏàòÏ†ï'
     */
    updateFile (type, title, item = this.selectedVersion) {
      this.setFileModal = {
        visible: true,
        type,
        title,
        data: item
      }
    },
    /**
     * [ÏÑ§Ïπò ÌååÏùº] ÏÇ≠Ï†ú
     */
    deleteFile ({ fileName, id, ...row }) {
      // `${fileName}<br>ÌååÏùºÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`
      this.$confirm(this.$t('service.INSTALL.ALERT.016', { fileName }), {
        dangerouslyUseHTMLString: true,
        confirmButtonText: this.$t('common.BTN.delete'),
        cancelButtonText: this.$t('common.BTN.cancel')
      }).then(async () => {
        const response = await API.sw.versionFileDelete(id)
        if (response) {
          // `${fileName}<br>ÌååÏùºÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`
          this.$alert(this.$t('service.INSTALL.ALERT.017', { fileName }), {
            dangerouslyUseHTMLString: true,
            callback: () => {
              this.refreshVersion()
              // this.init()
              // console.log(this.selectedVersion)
            }
          })
        }
      }).catch(() => false)
    },

    // -------------------------------------------------------------
    // ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã [ÏÑ§ÏπòÏä§ÌÅ¨Î¶ΩÌä∏ Í¥ÄÎ¶¨] ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã ‚óã
    // -------------------------------------------------------------

    /**
     * ÏÑ§ÏπòÏä§ÌÅ¨Î¶ΩÌä∏ Î™©Î°ù Îç∞Ïù¥ÌÑ∞ ÏÑ∏ÌåÖ
     * @param { Object } version Î≤ÑÏ†Ñ Ï†ïÎ≥¥
     */
    setInstallScriptData (version) {
      const masking = name => {
        if (name) return this.$options.filters.maskingName(name)
      }

      return version?.scriptList?.map(script => ({
        ...script,
        isUse: Boolean(script.isUse),
        statusName: this.simulationStatus[script.status],
        swScriptVersion: version.version + '.' + script.scriptVersion,
        user: script.createUserName + ' (' + masking(script.createUserId) + ')'
      }))
    },

    /**
     * ÏÇ¨Ïö© Ïó¨Î∂Ä Î≥ÄÍ≤ΩÏãú ÎèôÏûëÌï©ÎãàÎã§
     * @param { Object } row Ïä§ÌÅ¨Î¶ΩÌä∏ Î≤ÑÏ†Ñ Î™©Î°ù
     */
    async changeInstallScriptUsage (row) {
      const payload = {
        ...row,
        isUse: Number(row.isUse),
        updateUserIdx: this.user.userIdx,
        updateUserName: this.user.userName,
        updateUserId: this.user.userId
      }
      // console.log(JSON.stringify(payload))
      // console.log(payload)

      const result = await this.updateScriptDetail(payload)
      if (result) this.refreshVersion()
    },

    /**
     * Ïä§ÌÅ¨Î¶ΩÌä∏ Î≤ÑÏ†Ñ [ÏàòÏ†ï] - ÏÇ¨Ïö© / ÎØ∏ÏÇ¨Ïö© ÏÑ§Ï†ï
     */
    async updateScriptDetail (payload) {
      try {
        this.loading = true
        const response = await API.sw.updateScriptDetail(payload)
        return response
      } catch (error) {
        console.error('@@ updateScriptDetail : ', error)
        // ÏûëÏóÖÏùÑ Î≥ÄÍ≤ΩÌïòÎäî ÎèÑÏ§ë Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌïòÏòÄÏäµÎãàÎã§. <br> Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌï¥Ï£ºÏÑ∏Ïöî.
        this.$alert(this.$t('task.TODO.DETAIL.errorSave'), { dangerouslyUseHTMLString: true })
        return false
      } finally {
        this.loading = false
      }
    },

    /**
     * [ÏÑ§ÏπòÏä§ÌÅ¨Î¶ΩÌä∏] ÏÇ≠Ï†úÏãú ÏÑ∏ÌåÖ
     */
    setDeleteScript (status, item = null) {
      this.deleteScriptModal = {
        visible: status,
        item,
        value: undefined,
        disabled: true,
        name: `${this.$route.params.name}`
      }
    },
    /**
     * [ÏÑ§ÏπòÏä§ÌÅ¨Î¶ΩÌä∏] ÏÇ≠Ï†ú
     * ÏÇ≠Ï†ú ÏãúÏóêÎäî true Î•º ÎÇ¥Î≥¥ÎÇ¥Ï£ºÏñ¥ Ïï°ÏÖòÏùÑ Ï∑®ÌïòÍ≥†,
     * ÏïÑÎãêÍ≤ΩÏö∞ÏóêÎäî Í∑∏ÎÉ• ÏÇ≠Ï†ú Î™®Îã¨ close Îßå Ìï©ÎãàÎã§.
     * @param { Boolean } action
     */
    deleteScript (action) {
      if (action === true) {
        const param = {
          name: this.deleteScriptModal.name,
          version: this.deleteScriptModal.item.swScriptVersion
        }
        // `${this.deleteScriptModal.name} Script ${this.deleteScriptModal.item.swScriptVersion} (Ïù¥)Í∞Ä <br> ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.
        this.$alert(this.$t('service.INSTALL.ALERT.018', param), '', {
          dangerouslyUseHTMLString: true,
          callback: async () => {
            // ÏÑ§ÏπòÏä§ÌÅ¨Î¶ΩÌä∏ ÏÇ≠Ï†ú
            const response = await API.sw.deleteScript(this.deleteScriptModal.item.id)
            if (response) {
              this.refreshVersion()
              return this.setDeleteScript(false)
            }
          }
        })
      } else return this.setDeleteScript(false)
    }

  },
  data () {
    return {
      loading: false,
      installableVersionCount: 0,
      // ÌïÑÌÑ∞ÎßÅ Îç∞Ïù¥ÌÑ∞
      filteringOptions: [
        {
          field: 'osType',
          label: 'OS',
          placeholder: `OS ${this.$t('common.BTN.select')}`,
          selections: []
        },
        {
          field: 'bitType',
          label: this.$t('service.INSTALL.supportBit'), // ÏßÄÏõê Bit
          placeholder: `Bit ${this.$t('common.BTN.select')}`,
          selections: [
            { label: '64 bit', value: 64 },
            { label: '32 bit', value: 32 }
          ]
        },
        {
          field: 'status',
          label: this.$t('service.INSTALL.simulationStatus'), // ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏÉÅÌÉú
          // keyPath: 'service.INSTALL.COL.admin.ACCOUNT.state',
          placeholder: `${this.$t('admin.NOTI.state')} ${this.$t('common.BTN.select')}`,
          selections: [
            { label: this.$t('service.INSTALL.STATUS.UNEXECUTED'), value: 'UNEXECUTED' }, // ÎØ∏Ïã§Ìñâ
            { label: this.$t('service.INSTALL.STATUS.FAILED'), value: 'FAILED' }, // Ïã§Ìå®
            { label: this.$t('service.INSTALL.STATUS.SUCCESS'), value: 'SUCCESS' }, // ÏÑ±Í≥µ
            { label: this.$t('service.INSTALL.STATUS.IN_PROGRESS'), value: 'IN_PROGRESS' } // ÏßÑÌñâÏ§ë
          ]
        }
      ],
      viewInstallhistory: false, // ÏÑ§Ïπò Ïù¥Î†• Ï°∞Ìöå Î™®Îã¨ on/off
      params: {}, // version Í≤ÄÏÉâÏãú params
      osTypes: {}, // osType Ï†ïÎ¶¨
      swVersions: [],
      rawData: [], // swVersions Î•º ÏúÑÌïú rawData
      setSwModal: {
        visible: false, // SW Ï∂îÍ∞Ä Î™®Îã¨ on/off
        type: undefined // SW Ï∂îÍ∞Ä :: add / ÏàòÏ†ï :: update
      },
      setFileModal: {
        visible: false, // ÌååÏùºÏ∂îÍ∞Ä Î™®Îã¨ on/off
        type: undefined // ÌååÏùºÏ∂îÍ∞Ä :: add / ÏàòÏ†ï :: update
      },
      fileUploading: false, // ÌååÏùº ÏóÖÎ°úÎìúÏ§ëÏù∏ÏßÄ ÏÉÅÌÉú ÌôïÏù∏ (true/false)
      deleteSwModal: { // ÏÇ≠Ï†úÌï† [SW Î≤ÑÏ†Ñ]
        visible: false,
        item: null,
        value: undefined,
        disabled: true
      },
      deleteScriptModal: { // ÏÇ≠Ï†úÌï† ÏÑ§ÏπòÏä§ÌÅ¨Î¶ΩÌä∏
        visible: false,
        item: null,
        value: undefined,
        disabled: true
      },
      selectedVersion: null, // ÏÑ†ÌÉùÎêú Î≤ÑÏ†Ñ
      setNewTag (createDate) { // ÏÉùÏÑ±Îêú ÌõÑ 24ÏãúÍ∞Ñ ÏóêÎßå [N] ÌÉúÍ∑∏Î•º ÏÑ§Ï†ïÌï©ÎãàÎã§
        return (Date.now() - createDate) < 86400000
      },
      installFileColumn: [
        { header: 'ÏóÖÎ°úÎìúÏùº', binding: 'createDate', width: 180, keyPath: 'service.INSTALL.COL.uploadDate' },
        { header: 'ÌååÏùº ÏàúÏÑú', binding: 'order', width: 100, keyPath: 'service.INSTALL.COL.fileOrder' },
        { header: 'ÌååÏùº Ï¢ÖÎ•ò', binding: 'type', width: 200, keyPath: 'service.INSTALL.COL.fileType' },
        { header: 'ÌååÏùº Î™Ö', binding: 'fileName', keyPath: 'service.INSTALL.COL.fileName' },
        { header: 'Îì±Î°ùÌïú Í≥ÑÏ†ï', binding: 'user', width: 200, keyPath: 'service.INSTALL.COL.regId' },
        { header: 'ÌÅ¨Í∏∞', binding: 'size', width: 180, keyPath: 'service.INSTALL.COL.size' },
        { header: 'Í∏∞Îä•', binding: 'fn', width: 135, customHtml: true, keyPath: 'service.INSTALL.COL.func' }
      ],
      installFileData: [], // ÏÑ§Ïπò ÌååÏùº Í¥ÄÎ¶¨ Î™©Î°ù
      installScriptColumn: [
        { header: 'S/W Î≤ÑÏ†Ñ', binding: 'swScriptVersion', width: 160, keyPath: 'service.INSTALL.COL.swVer' },
        { header: 'ÏûëÏÑ±Ïûê', binding: 'user', width: 200, keyPath: 'service.INSTALL.COL.writer' },
        { header: 'ÏãúÎÆ¨Î†àÏù¥ÏÖò', binding: 'statusName', width: 160, customHtml: true, keyPath: 'service.INSTALL.COL.simulation' },
        { header: 'Ïä§ÌÅ¨Î¶ΩÌä∏', binding: 'script', customHtml: true, keyPath: 'service.INSTALL.COL.script' },
        { header: 'ÏÇ¨Ïö©Ïó¨Î∂Ä', binding: 'isUsing', width: 160, customHtml: true, keyPath: 'service.INSTALL.COL.isUse' },
        { header: 'Í∏∞Îä•', binding: 'fn', width: 135, align: 'justify', customHtml: true, keyPath: 'service.INSTALL.COL.func' }
      ],
      scriptTypes: [
        { label: 'Install', routeTo: 'install-program-script', query: { script: 'Install' } },
        { label: 'UnInstall', routeTo: 'install-program-script', query: { script: 'Uninstall' } }
        // { label: 'Update', routeTo: 'install-program-script', query: { script: 'Update' } },
        // { label: 'Read', routeTo: 'install-program-script', query: { script: 'Read' } }
      ],
      simulationStatus: { // ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏÉÅÌÉú
        UNEXECUTED: { name: this.$t('service.INSTALL.STATUS.UNEXECUTED'), css: '-ing' }, // ÎØ∏Ïã§Ìñâ
        FAILED: { name: this.$t('service.INSTALL.STATUS.FAILED'), css: '-fail' }, // Ïã§Ìå®
        SUCCESS: { name: this.$t('service.INSTALL.STATUS.SUCCESS'), css: '-success' }, // ÏÑ±Í≥µ
        IN_PROGRESS: { name: this.$t('service.INSTALL.STATUS.IN_PROGRESS'), css: '-ing' } // ÏßÑÌñâÏ§ë
      },
      // ÏÇ¨Ïö© / ÎØ∏ÏÇ¨Ïö©
      isUsingTypes: [{ label: this.$t('service.INSTALL.STATUS.use'), value: true }, { label: this.$t('service.INSTALL.STATUS.noUse'), value: false }],
      isUsingOption: [{ label: this.$t('service.INSTALL.STATUS.use'), value: 1 }, { label: this.$t('service.INSTALL.STATUS.noUse'), value: 0 }],
      installScriptData: [], // ÏÑ§ÏπòÏä§ÌÅ¨Î¶ΩÌä∏Í¥ÄÎ¶¨
      tabData: [
        { field: 'manageProgram', name: this.$v('VM Î≥Ñ ÏÑ§ÏπòÌîÑÎ°úÍ∑∏Îû® Í¥ÄÎ¶¨'), routeTo: 'set-account-user' },
        { field: 'manageScript', name: this.$v('ÏÑ§ÏπòÏä§ÌÅ¨Î¶ΩÌä∏ Í¥ÄÎ¶¨'), routeTo: 'set-account-admin' }
      ]
    }
  }
}
</script>

<style lang="scss" scoped>
.detail-wrapper {
  display: flex;

  > article:first-child {
    flex: 0 0 270px;
    height: 735px;

    .sw-version-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
      height: 32px;

      .-name {
        h6 {
          font-size: 16px;
          line-height: 16px;
        }
        small { color: $input-placeholder }
      }
    }

    .versions {
      margin-top: $gap-m;
      padding-right: 10px;;
      overflow-y: auto;
      height: 600px;

      .-item {
        height: 75px;
        border: 1px solid $purple-gray;
        border-radius: 6px;
        margin-bottom: $gap-s;
        display: flex;
        overflow: hidden;
        box-sizing: border-box;
        position: relative;
        cursor: pointer;
        transition: .3s ease background-color;
        &:last-child { margin: 0 }

        &.-selected {
          background-color: $white;
          .-info {
            .name {
              color: $text-black;
              .new { color: $white }
            }
          }
        }

        .status {
          display: block;
          flex: 0 0 5px;

          &.-success { background-color: $sea-blue }
          &.-fail { background-color: $main-red }
          &.-ing { background-color: $yellow }
        }

        .-info {
          padding: 15px;
          .name {
            display: flex;
            align-items: center;
            font-size: 14px;
            margin-bottom: $gap-s;
            line-height: 14px;
            transition: .3s ease color;
          }
        }

        .mdi {
          position: absolute;
          top: 15px; right: 15px;
          cursor: pointer;
        }
      }

      &.-empty {
        display: flex;
        align-items: center;
        justify-content: center;
        color: $input-placeholder;
      }
    }
  }

  > article:last-child {
    margin-left: $gap-m;
    flex: 1 1 auto;
    &.empty {
      height: inherit;
      background: rgba(193, 188, 208, 0.05);
      border: 1px dashed #727797;
      box-sizing: border-box;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: $white;
    }

    .simulation {
      &.-success { color: $sea-blue }
      &.-fail { color: $main-red }
      &.-ing { color: $yellow }
    }

    .script-types {
      color: $primary;
      text-decoration: underline;
      justify-content: center;
      li {
        cursor: pointer;
        margin: 0 30px;
      }
    }
  }

  .detail-description-wrapper {
    background-color: $dark-navy;
    max-height: 180px;
    margin-bottom: 40px;
    border-radius: $radius-m;
    padding: $gap;
    box-sizing: border-box;

    .detail-description {
      .version-desc-buttons {
        box-sizing: border-box;
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        height: 32px;

        small {
          display: block;
          height: 18px;
        }

        .button { margin-left: $gap-s; }
      }

      .description {
        margin-top: $gap;
        height: 70px;
        border: none;
        border-radius: 5px;
        box-sizing: border-box;
        overflow-y: auto;
        font-size: 13px;
        color: $light-gray;
        background-color: transparent;
        display: block;
        width: 100%;
        line-height: 1.5;
        resize: none;

        &:focus { outline: none;}
      }
    }

    .install-files { margin-bottom: $gap-s; }

  }

  .script-version-list-wrapper {
    width: 1300px;
  }

  .-title {
    font-size: 15px;
    display: flex;
    align-items: flex-end;

    small {
      display: block;
      margin-left: $gap-s;
      font-weight: normal;
      font-size: 10px;
    }
  }

  .new {
    width: 16px; height: 16px;
    display: block;
    line-height: 18px;
    text-align: center;
    background-color: $primary;
    border-radius: 1px;
    margin-right: 5px;
    font-size: 11px;
    transition: .3s ease color;
  }

  .info {
    border-radius: $radius-s;
    padding: 0 5px;
    line-height: 22px;
    font-size: 12px;
    &.type {
      background-color: #C0D7ED;
      color: $sea-blue;
      margin-right: 5px;
    }
    &.bit {
      background-color: #FCEADB;
      color: $yellow;
    }
  }

  .function-icons {
    display: flex;
    align-items: center;
    justify-content: center;
    > i:first-child { margin-right: 30px; }
  }

  .fade-enter-active, .fade-leave-active {
    transition: opacity .2s;
  }
  .fade-enter, .fade-leave-to /* .fade-leave-active below version 2.1.8 */ {
    opacity: 0;
  }

}
</style>

<style lang="scss">
.el-tooltip__popper {
  &.edit-modal-popper {
    border: none;
    p {
      line-height: 18px;
      width: auto;
      text-align: center;
      cursor: pointer;
      font-size: 12px;
    }
  }
}

.el-switch.is-checked {
  .el-switch__core {
    &::before { left: -11px !important; }
  }
}
</style>
